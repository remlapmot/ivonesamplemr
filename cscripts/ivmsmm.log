-------------------------------------------------------------------------------
      name:  ivmsmm
       log:  C:\Users\tom\Documents\GitHub\ivonesamplemr\cscripts\ivmsmm.log
  log type:  text
 opened on:  21 Aug 2023, 21:32:26

. // ivmsmm cscript
. // 2021-09-01
. 
. cscript ivmsmm adofiles ivmsmm
-------------------------------------------------------------------BEGIN ivmsmm

-> which ivmsmm, usesysdir
C:\Users\tom\Documents\GitHub\ivonesamplemr\ivmsmm.ado
*! 1.0.0 Tom Palmer 01sep2021

. 
. about

Stata/MP 17.0 for Windows (64-bit x86-64)
Revision 18 Jul 2023
Copyright 1985-2021 StataCorp LLC

Total physical memory:       32.00 GB
Available physical memory:   18.65 GB

Stata license: Unlimited-user 2-core network, expiring 21 Jan 2024
Serial number: 501709378202
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. ivmsmm y (x = z1)

Final GMM criterion Q(b) =  5.63e-33

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   2
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.388086   .0804624     5.66   0.000     1.239011    1.555097
       _cons |   .1942051   .0287407   -11.07   0.000     .1453081    .2595561
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: x
 Instruments: z1

. assert abs(_b[x] - .328) < 1e-3

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   2
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.388086   .0804624     5.66   0.000     1.239011    1.555097
       _cons |   .1942051   .0287407   -11.07   0.000     .1453081    .2595561
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: x
 Instruments: z1

. 
. mat list r(table)

r(table)[9,2]
                y:         y:
                x      _cons
     b   1.388086  .19420506
    se  .08046243  .02874071
     z  5.6571655  -11.07388
pvalue  1.539e-08  1.680e-28
    ll  1.2390112  .14530813
    ul  1.5550971  .25955606
    df          .          .
  crit   1.959964   1.959964
 eform          1          1

. 
. ivmsmm y (x = z1 z2 z3)

Final GMM criterion Q(b) =  .0004645

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.346121   .0440578     9.08   0.000      1.26248    1.435302
       _cons |     .20946   .0194699   -16.82   0.000      .174574    .2513173
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: x
 Instruments: z1 z2 z3

. assert abs(_b[x] - .297) < 1e-3

. cap noi estat overid

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.16116 (p = 0.5596)

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.346121   .0440578     9.08   0.000      1.26248    1.435302
       _cons |     .20946   .0194699   -16.82   0.000      .174574    .2513173
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: x
 Instruments: z1 z2 z3

. 
. // overid test
. estat overid

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.16116 (p = 0.5596)

. assert abs(r(J) - 1.161) < 1e-3

. assert r(J_df) == 2

. assert abs(r(J_p) - .56) < 1e-2

. 
. // ivpoisson helpfile
. webuse trip, clear
(Household trips)

. 
. * Generalized method of moments: multiplicative errors
. ivpoisson gmm trips cbd ptn worker weekend (tcost=pt), multiplicative

Step 1
Iteration 0:   GMM criterion Q(b) =  .04949852  
Iteration 1:   GMM criterion Q(b) =  .00011194  
Iteration 2:   GMM criterion Q(b) =  1.563e-08  
Iteration 3:   GMM criterion Q(b) =  3.685e-16  

Step 2
Iteration 0:   GMM criterion Q(b) =  2.287e-16  
Iteration 1:   GMM criterion Q(b) =  1.268e-31  

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   .0352185   .0098182     3.59   0.000     .0159752    .0544617
         cbd |   -.008398   .0020172    -4.16   0.000    -.0123517   -.0044444
         ptn |  -.0113146   .0021819    -5.19   0.000     -.015591   -.0070383
      worker |   .6623018   .0519909    12.74   0.000     .5604015     .764202
     weekend |   .3009323   .0362682     8.30   0.000     .2298479    .3720167
       _cons |   .2654423   .1550127     1.71   0.087    -.0383769    .5692616
------------------------------------------------------------------------------
Instrumented: tcost
 Instruments: cbd ptn worker weekend pt

. assert abs(_b[tcost] - .035) < 1e-3

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   1.035846   .0101701     3.59   0.000     1.016103    1.055972
         cbd |   .9916371   .0020003    -4.16   0.000     .9877243    .9955655
         ptn |   .9887491   .0021573    -5.19   0.000     .9845299    .9929864
      worker |   1.939251   .1008234    12.74   0.000     1.751376     2.14728
     weekend |   1.351118   .0490026     8.30   0.000     1.258409    1.450657
       _cons |   1.304008   .2021377     1.71   0.087     .9623501    1.766962
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: tcost
 Instruments: cbd ptn worker weekend pt

. 
. ivmsmm trips cbd ptn worker weekend (tcost=pt)

Final GMM criterion Q(b) =  1.27e-31

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   1.035846   .0101701     3.59   0.000     1.016103    1.055972
         cbd |   .9916371   .0020003    -4.16   0.000     .9877243    .9955655
         ptn |   .9887491   .0021573    -5.19   0.000     .9845299    .9929864
      worker |   1.939251   .1008234    12.74   0.000     1.751376     2.14728
     weekend |   1.351118   .0490026     8.30   0.000     1.258409    1.450657
       _cons |   1.304008   .2021377     1.71   0.087     .9623501    1.766962
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Instrumented: tcost
 Instruments: cbd ptn worker weekend pt

. assert abs(_b[tcost] - .035) < 1e-3

. 
end of do-file
      name:  ivmsmm
       log:  C:\Users\tom\Documents\GitHub\ivonesamplemr\cscripts\ivmsmm.log
  log type:  text
 closed on:  21 Aug 2023, 21:32:28
-------------------------------------------------------------------------------
