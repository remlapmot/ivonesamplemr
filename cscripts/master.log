-------------------------------------------------------------------------------
      name:  master
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/master.log
  log type:  text
 opened on:   1 May 2025, 21:27:20

. 
. cscript master
-------------------------------------------------------------------BEGIN master

. 
. cap noi ado describe ivonesamplemr

. 
. local cscripts ///
>     iv ///
>         ivlsmm ///
>         ivmsmm ///
>     ivtsps ///
>     ivtsri ///
>     ivmw ///
>         ivxtile ///
>     helpfiles

. 
. foreach dofile of local cscripts {
  2.     log using `dofile'.log, text replace name(`dofile')
  3.     do `dofile'
  4.     log close `dofile'
  5. }
-------------------------------------------------------------------------------
      name:  iv
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/iv.log
  log type:  text
 opened on:   1 May 2025, 21:27:20

. // ivlsmm cscript
. // 2021-08-27
. 
. cscript iv adofiles iv
-----------------------------------------------------------------------BEGIN iv

-> which iv, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/iv.ado
*! version 0.1.0 10sep2021 Tom Palmer

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. iv lsmm y (x = z1)

Final GMM criterion Q(b) =  1.36e-31

note: model is exactly identified.

GMM estimation 

Number of parameters =   5
Number of moments    =   5
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.238333   .0496761    24.93   0.000     1.140969    1.335696
      /xb_z1 |  -.2808945   .1005886    -2.79   0.005    -.4780446   -.0837444
         /b0 |  -2.259775   .1086805   -20.79   0.000    -2.472785   -2.046765
     /cmxb_x |   .9460553   .1080615     8.75   0.000     .7342587    1.157852
        /ey0 |    .150554   .0332163     4.53   0.000     .0854512    .2156567
------------------------------------------------------------------------------
Instruments for equation 1: x z1 _cons
Instruments for equation 2: z1 _cons

  Test of overidentifying restriction:

  Hansen's J chi2(0) = 3.4e-28 (p =     .)

Note: test cannot be performed because there are no
      overidentifying restrictions.

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    2.57553   .2783156     8.75   0.000     2.083937    3.183089
------------------------------------------------------------------------------

. 
. iv msmm y (x = z1 z2 z3)

Final GMM criterion Q(b) =  .0004645

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.346121   .0440578     9.08   0.000      1.26248    1.435302
       _cons |     .20946   .0194699   -16.82   0.000      .174574    .2513173
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: x
Exogenous:  z1 z2 z3

. 
. iv tsps y (x = z1 z2 z3)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. 
. iv tsri y (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  6.85e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .8518266   .0648163    13.14   0.000      .724789    .9788641
         /b2 |   .5726491   .0694512     8.25   0.000     .4365273    .7087709
         /b0 |  -1.675875    .133441   -12.56   0.000    -1.937415   -1.414336
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.343924   .1519244    13.14   0.000     2.064296    2.661431
------------------------------------------------------------------------------

Causal odds ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.772958    .123134     8.25   0.000     1.547325    2.031493
------------------------------------------------------------------------------

. 
end of do-file
      name:  iv
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/iv.log
  log type:  text
 closed on:   1 May 2025, 21:27:21
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivlsmm
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivlsmm.log
  log type:  text
 opened on:   1 May 2025, 21:27:21

. // ivlsmm cscript
. // 2021-08-27
. 
. cscript ivlsmm adofiles ivlsmm
-------------------------------------------------------------------BEGIN ivlsmm

-> which ivlsmm, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivlsmm.ado
*! 1.0.0 Tom Palmer 01sep2021

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. discard

. ivlsmm y w (x = z1)

Final GMM criterion Q(b) =  1.78e-30

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.142773   .0515592    22.16   0.000     1.041719    1.243827
      /xb_z1 |   -.125428   .1051645    -1.19   0.233    -.3315465    .0806906
       /xb_w |   .6714291   .0708208     9.48   0.000      .532623    .8102353
         /b0 |  -2.181456   .1134677   -19.23   0.000    -2.403849   -1.959063
     /cmxb_x |   1.009534   .1131745     8.92   0.000     .7877157    1.231352
     /cmxb_w |   .8040886   .1199973     6.70   0.000     .5688983    1.039279
        /ey0 |   .1218896   .0252702     4.82   0.000     .0723609    .1714182
------------------------------------------------------------------------------
Instruments for equation 1: x z1 w _cons
Instruments for equation 2: z1 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(0) = 4.4e-27 (p =     .)

Note: test cannot be performed because there are no
      overidentifying restrictions.

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.744321   .3105872     8.92   0.000     2.198369    3.425857
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.234659   .2681529     6.70   0.000      1.76632    2.827177
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - 1) < 1e-2

. 
. // estimates replay
. ivlsmm

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.142773   .0515592    22.16   0.000     1.041719    1.243827
      /xb_z1 |   -.125428   .1051645    -1.19   0.233    -.3315465    .0806906
       /xb_w |   .6714291   .0708208     9.48   0.000      .532623    .8102353
         /b0 |  -2.181456   .1134677   -19.23   0.000    -2.403849   -1.959063
     /cmxb_x |   1.009534   .1131745     8.92   0.000     .7877157    1.231352
     /cmxb_w |   .8040886   .1199973     6.70   0.000     .5688983    1.039279
        /ey0 |   .1218896   .0252702     4.82   0.000     .0723609    .1714182
------------------------------------------------------------------------------

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.744321   .3105872     8.92   0.000     2.198369    3.425857
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.234659   .2681529     6.70   0.000      1.76632    2.827177
------------------------------------------------------------------------------

. 
. // ereturn list
. eret list

scalars:
                  e(J) =  4.44363770968e-27
                e(J_p) =  .
               e(J_df) =  0
         e(k_eq_model) =  0
              e(k_aux) =  7
               e(k_eq) =  7
          e(n_moments) =  7
                  e(k) =  7
               e(n_eq) =  2
               e(type) =  1
         e(has_xtinst) =  0
          e(converged) =  1
                e(k_2) =  7
                e(k_1) =  4
                  e(Q) =  1.77745508387e-30
                  e(N) =  2500
               e(rank) =  7

macros:
               e(inst) : "z1"
               e(exog) : "w"
              e(endog) : "x"
                e(lhs) : "y"
            e(cmdline) : "ivlsmm y w (x = z1)"
                e(cmd) : "ivlsmm"
          e(estat_cmd) : "gmm_estat"
            e(predict) : "gmm_p"
       e(marginsnotok) : "Residuals SCores"
          e(marginsok) : "xb"
        e(marginsprop) : "allcons nochainrule"
            e(eqnames) : "1 2"
          e(technique) : "gn"
              e(winit) : "Unadjusted"
          e(estimator) : "twostep"
            e(wmatrix) : "robust"
                e(vce) : "robust"
            e(vcetype) : "Robust"
             e(params) : "xb_x xb_z1 xb_w b0 cmxb_x cmxb_w ey0"
             e(inst_2) : "z1 w _cons"
           e(params_2) : "b0 cmxb_x cmxb_w ey0"
             e(sexp_2) : "invlogit(({xb_x}*x+{xb_z1}*z1+{xb_w}*w)+{b0}-({cm.."
             e(inst_1) : "x z1 w _cons"
           e(params_1) : "xb_x xb_z1 xb_w b0"
             e(sexp_1) : "y-invlogit(({xb_x}*x+{xb_z1}*z1+{xb_w}*w)+{b0})"
         e(properties) : "b V"

matrices:
                  e(b) :  1 x 7
                  e(V) :  7 x 7
               e(init) :  1 x 7
       e(V_modelbased) :  7 x 7
                  e(S) :  7 x 7
                  e(W) :  7 x 7

functions:
             e(sample)   

. 
. // r(table)
. mat list r(table)

r(table)[9,7]
              xb_x:      xb_z1:       xb_w:         b0:     cmxb_x:     cmxb_w:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   1.1427731  -.12542797   .67142912  -2.1814559   1.0095337   .80408856
    se   .05155918   .10516447   .07082077   .11346774    .1131745   .11999725
     z     22.1643  -1.1926838   9.4806809   -19.22534   8.9201512   6.7008913
pvalue   7.59e-109   .23299322   2.526e-21   2.271e-82   4.657e-19   2.072e-11
    ll    1.041719  -.33154655   .53262296  -2.4038486   .78771574   .56889827
    ul   1.2438272   .08069061   .81023528  -1.9590633   1.2313516   1.0392789
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

               ey0:
             _cons
     b   .12188959
    se   .02527018
     z   4.8234546
pvalue   1.411e-06
    ll   .07236094
    ul   .17141824
    df           .
  crit    1.959964
 eform           0

. 
. // multiple instruments
. discard

. ivlsmm y w (x = z1 z2 z3)

Final GMM criterion Q(b) =  .0010781

GMM estimation 

Number of parameters =   9
Number of moments    =  11
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.299434   .0604193    21.51   0.000     1.181014    1.417854
      /xb_z1 |  -.4095171   .0757369    -5.41   0.000    -.5579587   -.2610756
      /xb_z2 |  -.3847453   .0666832    -5.77   0.000    -.5154419   -.2540487
      /xb_z3 |  -.3958253   .0694519    -5.70   0.000    -.5319485   -.2597022
       /xb_w |   .5482842   .0729194     7.52   0.000     .4053647    .6912036
         /b0 |  -1.806069   .1288229   -14.02   0.000    -2.058557   -1.553581
     /cmxb_x |   .8858407   .0654348    13.54   0.000     .7575907    1.014091
     /cmxb_w |   .9554105   .0876054    10.91   0.000      .783707    1.127114
        /ey0 |   .1581863   .0197955     7.99   0.000     .1193879    .1969848
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 w _cons
Instruments for equation 2: z1 z2 z3 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 2.69532 (p = 0.2598)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.425022    .158681    13.54   0.000     2.133131    2.756855
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.599738   .2277511    10.91   0.000     2.189574    3.086735
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - .89) < 1e-2

. 
. // multiple endog variables
. discard

. ivlsmm y w (x1 x2 = z1 z2 z3)

Final GMM criterion Q(b) =  .0008332

GMM estimation 

Number of parameters =  11
Number of moments    =  12
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
      /xb_x1 |   1.301441   .0607291    21.43   0.000     1.182414    1.420468
      /xb_x2 |  -.0553908   .0569069    -0.97   0.330    -.1669262    .0561447
      /xb_z1 |  -.4028659   .0787291    -5.12   0.000    -.5571722   -.2485596
      /xb_z2 |  -.4199986   .0896648    -4.68   0.000    -.5957384   -.2442588
      /xb_z3 |  -.3700852   .0886886    -4.17   0.000    -.5439117   -.1962587
       /xb_w |   .5490761   .0728846     7.53   0.000     .4062249    .6919274
         /b0 |  -1.809935   .1289064   -14.04   0.000    -2.062587   -1.557284
    /cmxb_x1 |   .8629792   .0843771    10.23   0.000     .6976032    1.028355
    /cmxb_x2 |  -.8157772   1.427452    -0.57   0.568    -3.613532    1.981977
     /cmxb_w |   .9755589    .098335     9.92   0.000     .7828259    1.168292
        /ey0 |   .1863564   .0900914     2.07   0.039     .0097805    .3629324
------------------------------------------------------------------------------
Instruments for equation 1: x1 x2 z1 z2 z3 w _cons
Instruments for equation 2: z1 z2 z3 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(1) = 2.08312 (p = 0.1489)

Causal odds ratio for: x1

 ( 1)  [cmxb_x1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.370212   .1999915    10.23   0.000     2.008932    2.796463
------------------------------------------------------------------------------

Causal odds ratio for: x2

 ( 1)  [cmxb_x2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .4422954   .6313555    -0.57   0.568     .0269565    7.257078
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.652649   .2608483     9.92   0.000     2.187646    3.216494
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x1] - .86) < 1e-2

. assert abs(_b[/cmxb_x2] - -.82) < 1e-2

. 
. mat start = J(1,9,1)

. mat list start

start[1,9]
    c1  c2  c3  c4  c5  c6  c7  c8  c9
r1   1   1   1   1   1   1   1   1   1

. discard

. ivlsmm y w (x = z1 z2 z3), from(start)

Final GMM criterion Q(b) =  .0010781

GMM estimation 

Number of parameters =   9
Number of moments    =  11
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.299434   .0604193    21.51   0.000     1.181015    1.417854
      /xb_z1 |  -.4095179   .0757368    -5.41   0.000    -.5579593   -.2610764
      /xb_z2 |   -.384745   .0666832    -5.77   0.000    -.5154416   -.2540483
      /xb_z3 |  -.3958253   .0694519    -5.70   0.000    -.5319485   -.2597021
       /xb_w |   .5482841   .0729194     7.52   0.000     .4053646    .6912035
         /b0 |  -1.806069   .1288229   -14.02   0.000    -2.058557   -1.553581
     /cmxb_x |   .8858406   .0654348    13.54   0.000     .7575907    1.014091
     /cmxb_w |   .9554105   .0876054    10.91   0.000      .783707    1.127114
        /ey0 |   .1581864   .0197955     7.99   0.000     .1193879    .1969848
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 w _cons
Instruments for equation 2: z1 z2 z3 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 2.69534 (p = 0.2598)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.425022   .1586809    13.54   0.000     2.133131    2.756855
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.599737   .2277511    10.91   0.000     2.189574    3.086735
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - .89) < 1e-2

. 
. // check if in working
. discard

. ivlsmm y (x = z1 z2 z3) if _n <= 100

Final GMM criterion Q(b) =  .0133962

GMM estimation 

Number of parameters =   7
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =        100
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.763694   .3324165     5.31   0.000      1.11217    2.415218
      /xb_z1 |  -.4448383   .3623707    -1.23   0.220    -1.155072    .2653952
      /xb_z2 |  -.8001791   .4165426    -1.92   0.055    -1.616588    .0162294
      /xb_z3 |  -.4429923   .3975396    -1.11   0.265    -1.222156     .336171
         /b0 |  -1.863253   .7113749    -2.62   0.009    -3.257522   -.4689836
     /cmxb_x |   1.206102   .3389122     3.56   0.000     .5418467    1.870358
        /ey0 |   .1536548   .1011149     1.52   0.129    -.0445268    .3518364
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 _cons
Instruments for equation 2: z1 z2 z3 _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.33962 (p = 0.5118)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    3.34044   1.132116     3.56   0.000     1.719179    6.490621
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - 1.21) < 1e-2

. 
. discard

. ivlsmm y (x = z1 z2 z3) in 1/100

Final GMM criterion Q(b) =  .0133962

GMM estimation 

Number of parameters =   7
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =        100
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.763694   .3324165     5.31   0.000      1.11217    2.415218
      /xb_z1 |  -.4448383   .3623707    -1.23   0.220    -1.155072    .2653952
      /xb_z2 |  -.8001791   .4165426    -1.92   0.055    -1.616588    .0162294
      /xb_z3 |  -.4429923   .3975396    -1.11   0.265    -1.222156     .336171
         /b0 |  -1.863253   .7113749    -2.62   0.009    -3.257522   -.4689836
     /cmxb_x |   1.206102   .3389122     3.56   0.000     .5418467    1.870358
        /ey0 |   .1536548   .1011149     1.52   0.129    -.0445268    .3518364
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 _cons
Instruments for equation 2: z1 z2 z3 _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.33962 (p = 0.5118)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    3.34044   1.132116     3.56   0.000     1.719179    6.490621
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - 1.21) < 1e-2

. 
. // check `options'
. discard

. ivlsmm y (x = z1 z2 z3) if _n <= 100

Final GMM criterion Q(b) =  .0133962

GMM estimation 

Number of parameters =   7
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =        100
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.763694   .3324165     5.31   0.000      1.11217    2.415218
      /xb_z1 |  -.4448383   .3623707    -1.23   0.220    -1.155072    .2653952
      /xb_z2 |  -.8001791   .4165426    -1.92   0.055    -1.616588    .0162294
      /xb_z3 |  -.4429923   .3975396    -1.11   0.265    -1.222156     .336171
         /b0 |  -1.863253   .7113749    -2.62   0.009    -3.257522   -.4689836
     /cmxb_x |   1.206102   .3389122     3.56   0.000     .5418467    1.870358
        /ey0 |   .1536548   .1011149     1.52   0.129    -.0445268    .3518364
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 _cons
Instruments for equation 2: z1 z2 z3 _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.33962 (p = 0.5118)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    3.34044   1.132116     3.56   0.000     1.719179    6.490621
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - 1.21) < 1e-2

. 
. // amxb test
. discard

. ivlsmm y w (x = z1 z2 z3), amxb(x z1 z2 z3)

Final GMM criterion Q(b) =  .0009336

GMM estimation 

Number of parameters =   8
Number of moments    =  10
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.423979   .0577045    24.68   0.000     1.310881    1.537078
      /xb_z1 |  -.5711436   .0740573    -7.71   0.000    -.7162932   -.4259939
      /xb_z2 |  -.5337384   .0647331    -8.25   0.000     -.660613   -.4068639
      /xb_z3 |  -.5494056   .0667925    -8.23   0.000    -.6803164   -.4184948
         /b0 |  -1.728888   .1250831   -13.82   0.000    -1.974046   -1.483729
     /cmxb_x |   .8497166   .0638232    13.31   0.000     .7246254    .9748078
     /cmxb_w |   .5655056   .0700267     8.08   0.000     .4282559    .7027553
        /ey0 |   .1814932   .0210319     8.63   0.000     .1402713     .222715
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 _cons
Instruments for equation 2: z1 z2 z3 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) =  2.3341 (p = 0.3113)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.338984   .1492814    13.31   0.000     2.063958    2.650658
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.760338   .1232706     8.08   0.000     1.534579    2.019309
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - .85) < 1e-2

. 
. discard

. gen xz1 = x*z1

. gen xz2 = x*z2

. gen xz3 = x*z3

. ivlsmm y w (x = z1 z2 z3), amxb(x w z1 z2 z3 xz1 xz2 xz3)

Final GMM criterion Q(b) =   .001119

GMM estimation 

Number of parameters =  12
Number of moments    =  14
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.352266   .1085224    12.46   0.000     1.139566    1.564966
       /xb_w |   .5585769   .0733551     7.61   0.000     .4148035    .7023502
      /xb_z1 |  -.3413226   .2099725    -1.63   0.104    -.7528612    .0702159
      /xb_z2 |  -.7431018   .1930832    -3.85   0.000    -1.121538   -.3646657
      /xb_z3 |  -.0862605   .1682969    -0.51   0.608    -.4161165    .2435954
     /xb_xz1 |  -.0264955   .0747982    -0.35   0.723    -.1730972    .1201063
     /xb_xz2 |   .1348796   .0731238     1.84   0.065    -.0084403    .2781996
     /xb_xz3 |  -.1321727   .0698304    -1.89   0.058    -.2690379    .0046924
         /b0 |  -1.889602   .2086502    -9.06   0.000    -2.298549   -1.480655
     /cmxb_x |   .8970595   .0718033    12.49   0.000     .7563277    1.037791
     /cmxb_w |   .9628362   .0932364    10.33   0.000     .7800962    1.145576
        /ey0 |   .1573063   .0205315     7.66   0.000     .1170652    .1975473
------------------------------------------------------------------------------
Instruments for equation 1: x w z1 z2 z3 xz1 xz2 xz3 _cons
Instruments for equation 2: z1 z2 z3 w _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 2.79747 (p = 0.2469)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.452381    .176089    12.49   0.000     2.130438    2.822975
------------------------------------------------------------------------------

Causal odds ratio for: w

 ( 1)  [cmxb_w]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.619114   .2441969    10.33   0.000     2.181682    3.144253
------------------------------------------------------------------------------

. assert abs(_b[/cmxb_x] - .90) < 1e-2

. 
. // overid test
. ivlsmm y (x = z1 z2 z3)

Final GMM criterion Q(b) =  .0007528

GMM estimation 

Number of parameters =   7
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =      2,500
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       /xb_x |   1.424852   .0577536    24.67   0.000     1.311657    1.538047
      /xb_z1 |  -.5607264   .0743176    -7.55   0.000    -.7063861   -.4150666
      /xb_z2 |  -.5449099   .0661095    -8.24   0.000    -.6744822   -.4153376
      /xb_z3 |  -.5506151   .0684751    -8.04   0.000    -.6848238   -.4164063
         /b0 |  -1.726392   .1251155   -13.80   0.000    -1.971613    -1.48117
     /cmxb_x |   .8547843   .0660029    12.95   0.000      .725421    .9841475
        /ey0 |   .1938915    .023668     8.19   0.000      .147503      .24028
------------------------------------------------------------------------------
Instruments for equation 1: x z1 z2 z3 _cons
Instruments for equation 2: z1 z2 z3 _cons

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.88188 (p = 0.3903)

Causal odds ratio for: x

 ( 1)  [cmxb_x]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.350867   .1551639    12.95   0.000     2.065601     2.67553
------------------------------------------------------------------------------

. assert abs(e(J) - 1.882) < 1e-3

. assert e(J_df) == 2

. assert abs(e(J_p) - .39) < 1e-2

. 
end of do-file
      name:  ivlsmm
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivlsmm.log
  log type:  text
 closed on:   1 May 2025, 21:27:23
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivmsmm
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivmsmm.log
  log type:  text
 opened on:   1 May 2025, 21:27:23

. // ivmsmm cscript
. // 2021-09-01
. 
. cscript ivmsmm adofiles ivmsmm
-------------------------------------------------------------------BEGIN ivmsmm

-> which ivmsmm, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivmsmm.ado
*! 1.0.0 Tom Palmer 01sep2021

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. ivmsmm y (x = z1)

Final GMM criterion Q(b) =  5.69e-33

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   2
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.388086   .0804624     5.66   0.000     1.239011    1.555097
       _cons |   .1942051   .0287407   -11.07   0.000     .1453081    .2595561
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: x
Exogenous:  z1

. assert abs(_b[x] - .328) < 1e-3

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   2
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.388086   .0804624     5.66   0.000     1.239011    1.555097
       _cons |   .1942051   .0287407   -11.07   0.000     .1453081    .2595561
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: x
Exogenous:  z1

. 
. mat list r(table)

r(table)[9,2]
                y:         y:
                x      _cons
     b   1.388086  .19420506
    se  .08046243  .02874071
     z  5.6571655  -11.07388
pvalue  1.539e-08  1.680e-28
    ll  1.2390112  .14530813
    ul  1.5550971  .25955606
    df          .          .
  crit   1.959964   1.959964
 eform          1          1

. 
. ivmsmm y (x = z1 z2 z3)

Final GMM criterion Q(b) =  .0004645

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.346121   .0440578     9.08   0.000      1.26248    1.435302
       _cons |     .20946   .0194699   -16.82   0.000      .174574    .2513173
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: x
Exogenous:  z1 z2 z3

. assert abs(_b[x] - .297) < 1e-3

. cap noi estat overid

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.16116 (p = 0.5596)

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.346121   .0440578     9.08   0.000      1.26248    1.435302
       _cons |     .20946   .0194699   -16.82   0.000      .174574    .2513173
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: x
Exogenous:  z1 z2 z3

. 
. // overid test
. estat overid

  Test of overidentifying restriction:

  Hansen's J chi2(2) = 1.16116 (p = 0.5596)

. assert abs(r(J) - 1.161) < 1e-3

. assert r(J_df) == 2

. assert abs(r(J_p) - .56) < 1e-2

. 
. // ivpoisson helpfile
. webuse trip, clear
(Household trips)

. 
. * Generalized method of moments: multiplicative errors
. ivpoisson gmm trips cbd ptn worker weekend (tcost=pt), multiplicative

Step 1:
Iteration 0:  GMM criterion Q(b) =  .04949852  
Iteration 1:  GMM criterion Q(b) =  .00011194  
Iteration 2:  GMM criterion Q(b) =  1.563e-08  
Iteration 3:  GMM criterion Q(b) =  3.685e-16  

Step 2:
Iteration 0:  GMM criterion Q(b) =  2.287e-16  
Iteration 1:  GMM criterion Q(b) =  1.267e-31  

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   .0352185   .0098182     3.59   0.000     .0159752    .0544617
         cbd |   -.008398   .0020172    -4.16   0.000    -.0123517   -.0044444
         ptn |  -.0113146   .0021819    -5.19   0.000     -.015591   -.0070383
      worker |   .6623018   .0519909    12.74   0.000     .5604015     .764202
     weekend |   .3009323   .0362682     8.30   0.000     .2298479    .3720167
       _cons |   .2654423   .1550127     1.71   0.087    -.0383769    .5692616
------------------------------------------------------------------------------
Endogenous: tcost
Exogenous:  cbd ptn worker weekend pt

. assert abs(_b[tcost] - .035) < 1e-3

. ivpoisson, irr

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   1.035846   .0101701     3.59   0.000     1.016103    1.055972
         cbd |   .9916371   .0020003    -4.16   0.000     .9877243    .9955655
         ptn |   .9887491   .0021573    -5.19   0.000     .9845299    .9929864
      worker |   1.939251   .1008234    12.74   0.000     1.751376     2.14728
     weekend |   1.351118   .0490026     8.30   0.000     1.258409    1.450657
       _cons |   1.304008   .2021377     1.71   0.087     .9623501    1.766962
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: tcost
Exogenous:  cbd ptn worker weekend pt

. 
. ivmsmm trips cbd ptn worker weekend (tcost=pt)

Final GMM criterion Q(b) =  1.27e-31

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   6                         Number of obs  =      5,000
Number of moments    =   6
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
       trips |        IRR   std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       tcost |   1.035846   .0101701     3.59   0.000     1.016103    1.055972
         cbd |   .9916371   .0020003    -4.16   0.000     .9877243    .9955655
         ptn |   .9887491   .0021573    -5.19   0.000     .9845299    .9929864
      worker |   1.939251   .1008234    12.74   0.000     1.751376     2.14728
     weekend |   1.351118   .0490026     8.30   0.000     1.258409    1.450657
       _cons |   1.304008   .2021377     1.71   0.087     .9623501    1.766962
------------------------------------------------------------------------------
Note: _cons estimates baseline incidence rate.
Endogenous: tcost
Exogenous:  cbd ptn worker weekend pt

. assert abs(_b[tcost] - .035) < 1e-3

. 
end of do-file
      name:  ivmsmm
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivmsmm.log
  log type:  text
 closed on:   1 May 2025, 21:27:25
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivtsps
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsps.log
  log type:  text
 opened on:   1 May 2025, 21:27:25

. // ivtsps cscript
. // 2021-09-06
. 
. cscript ivtsps adofiles ivtsps
-------------------------------------------------------------------BEGIN ivtsps

-> which ivtsps, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivtsps.ado
*! 1.0.0 Tom Palmer 05sep2021

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. // identity link
. 
. ivregress gmm y (x = z1 z2 z3)

Instrumental-variables GMM regression             Number of obs   =      2,500
                                                  Wald chi2(1)    =     207.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.3690
GMM weight matrix: Robust                         Root MSE        =     .39694

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1071817   .0074402    14.41   0.000     .0925993    .1217642
       _cons |   .2879039   .0157363    18.30   0.000     .2570612    .3187465
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar bx1 = _b[x]

. scalar sx1 = _se[x]

. ivtsps y (x = z1 z2 z3)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. mat list r(table)

r(table)[9,6]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b0:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .10700195   .28799166
    se   .06148771   .05255718   .04950525   .06759281   .00744244    .0157401
     z    16.17536   18.152756   19.299427   1.2460557   14.377259    18.29668
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   7.189e-47   8.795e-75
    ll   .87407217   .85104744   .85839444  -.04825507   .09241503   .25714162
    ul   1.1150996   1.0570678   1.0524514   .21670387   .12158887   .31884169
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

. 
. ivregress gmm y (x = z1 z2 z3) if _n <= 50

Instrumental-variables GMM regression             Number of obs   =         50
                                                  Wald chi2(1)    =      36.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.5501
GMM weight matrix: Robust                         Root MSE        =     .33512

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1781062   .0294317     6.05   0.000     .1204211    .2357912
       _cons |   .2258489   .0642993     3.51   0.000     .0998245    .3518732
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar bx2 = _b[x]

. scalar sx2 = _se[x]

. ivtsps y (x = z1 z2 z3) if _n <= 50

Final GMM criterion Q(b) =  2.31e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =         50

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   1.060589   .3962486     2.68   0.007     .2839558    1.837222
    /s1xb_z2 |   1.148148   .3925519     2.92   0.003     .3787603    1.917535
    /s1xb_z3 |   1.403546   .3177779     4.42   0.000      .780713    2.026379
         /a0 |  -.5013724   .3595452    -1.39   0.163    -1.206068    .2033233
         /b1 |      .1713   .0290798     5.89   0.000     .1143046    .2282954
         /b0 |   .2434077   .0653369     3.73   0.000     .1153498    .3714656
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |      .1713   .0290798     5.89   0.000     .1143046    .2282954
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx2)) < 1e-3

. 
. ivtsps y (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. 
. ivregress gmm y w (x = z1 z2 z3)

Instrumental-variables GMM regression             Number of obs   =      2,500
                                                  Wald chi2(2)    =    1628.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.4202
GMM weight matrix: Robust                         Root MSE        =     .38051

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1054227   .0073416    14.36   0.000     .0910334     .119812
           w |   .1159165    .010589    10.95   0.000     .0951624    .1366707
       _cons |   .2865861   .0150723    19.01   0.000     .2570449    .3161273
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  w z1 z2 z3

. scalar bx3 = _b[x]

. scalar sx3 = _se[x]

. ivtsps y w (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  1.30e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
 /s2exogxb_w |   .1160821   .0105911    10.96   0.000     .0953239    .1368403
         /b0 |   .2867508   .0150764    19.02   0.000     .2572016       .3163
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx3)) < 1e-3

. 
. ivtsps y (x = z1 z2 z3), estonly

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(bx1)) < 1e-2

. 
. // logadd link
. 
. ivpoisson gmm y (x = z1 z2 z3), add nolog

Final GMM criterion Q(b) =  .0004684

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .2111395   .0148693    14.20   0.000     .1819962    .2402828
       _cons |  -1.203142   .0468509   -25.68   0.000    -1.294969   -1.111316
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar lrr1 = _b[x]

. scalar selrr1 = _se[x]

. ivtsps y (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  7.54e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2130699   .0149322    14.27   0.000     .1838034    .2423364
         /b0 |  -1.141337   .0389282   -29.32   0.000    -1.217634   -1.065039
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.237471   .0184781    14.27   0.000      1.20178    1.274223
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2130699   .0149322    14.27   0.000     .1838034    .2423364
         /b0 |  -1.141337   .0389282   -29.32   0.000    -1.217634   -1.065039
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.237471   .0184781    14.27   0.000      1.20178    1.274223
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr1)) < 1e-2

. mat list r(table)

r(table)[9,6]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b0:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .21306991  -1.1413365
    se   .06148771   .05255718   .04950525   .06759281   .01493217   .03892822
     z    16.17536   18.152756   19.299427   1.2460557   14.269183  -29.319003
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   3.405e-46   5.94e-189
    ll   .87407217   .85104744   .85839444  -.04825507   .18380339  -1.2176344
    ul   1.1150996   1.0570678   1.0524514   .21670387   .24233643  -1.0650386
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

. 
. ivpoisson gmm y (x = z1 z2 z3) if _n <= 200, add nolog

Final GMM criterion Q(b) =  .0136351

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =        200
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .2041092   .0443505     4.60   0.000     .1171838    .2910346
       _cons |  -1.093612   .1396017    -7.83   0.000    -1.367226   -.8199976
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar lrr2 = _b[x]

. scalar selrr2 = _se[x]

. ivtsps y (x = z1 z2 z3) if _n <= 200, link(logadd)

Final GMM criterion Q(b) =  1.08e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        200

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .960665   .1863621     5.15   0.000      .595402    1.325928
    /s1xb_z2 |   1.017943   .1993872     5.11   0.000     .6271518    1.408735
    /s1xb_z3 |   1.105939   .1977604     5.59   0.000     .7183356    1.493542
         /a0 |  -.1036275   .2498245    -0.41   0.678    -.5932745    .3860195
         /b1 |   .2137135   .0426471     5.01   0.000     .1301268    .2973001
         /b0 |  -1.050832   .1150838    -9.13   0.000    -1.276393   -.8252724
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.238268   .0528085     5.01   0.000     1.138973    1.346219
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr2)) < 1e-2

. 
. ivpoisson gmm y w (x = z1 z2 z3), add nolog

Final GMM criterion Q(b) =   .000531

Exponential mean model with endogenous regressors

Number of parameters =   3                         Number of obs  =      2,500
Number of moments    =   5
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .2030899    .015625    13.00   0.000     .1724655    .2337143
           w |   .2455423   .0228433    10.75   0.000     .2007703    .2903144
       _cons |  -1.273175   .0445619   -28.57   0.000    -1.360515   -1.185836
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  w z1 z2 z3

. scalar lrr3 = _b[x]

. scalar selrr3 = _se[x]

. ivtsps y w (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  1.85e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .2040871   .0154347    13.22   0.000     .1738357    .2343385
 /s2exogxb_w |   .2436231   .0224021    10.87   0.000     .1997157    .2875304
         /b0 |   -1.23406    .039312   -31.39   0.000     -1.31111    -1.15701
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.226405   .0189292    13.22   0.000      1.18986    1.264072
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logadd) estonly

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .2130699   .0266058     8.01   0.000     .1609235    .2652164
       _cons |  -1.141337   .0620139   -18.40   0.000    -1.262881   -1.019792
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .2130699   .0266058     8.01   0.000     .1609235    .2652164
       _cons |  -1.141337   .0620139   -18.40   0.000    -1.262881   -1.019792
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lrr1)) < 1e-2

. 
. // logmult link
. 
. cap noi drop pred
variable pred not found

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. glm y pred, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =      2,500
Optimization     : ML                             Residual df     =      2,498
                                                  Scale parameter =   1.180567
Deviance         =   891.997719                   (1/df) Deviance =   .3570848
Pearson          =  2949.056568                   (1/df) Pearson  =   1.180567

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .4940004
Log likelihood   = -615.5005255                   BIC             =  -18652.47

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        pred |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. scalar lmrr1 = _b[pred]

. scalar selmrr1 = _se[pred]

. ivtsps y (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  6.77e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2223683   .0179645    12.38   0.000     .1871585     .257578
         /b0 |  -1.159476   .0439471   -26.38   0.000    -1.245611   -1.073341
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.249031   .0224382    12.38   0.000     1.205818    1.293793
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2223683   .0179645    12.38   0.000     .1871585     .257578
         /b0 |  -1.159476   .0439471   -26.38   0.000    -1.245611   -1.073341
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.249031   .0224382    12.38   0.000     1.205818    1.293793
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr1)) < 1e-2

. mat list r(table)

r(table)[9,6]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b0:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .22236826   -1.159476
    se   .06148771   .05255718   .04950525   .06759281   .01796449    .0439471
     z    16.17536   18.152756   19.299427   1.2460557    12.37821  -26.383443
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   3.429e-35   2.12e-153
    ll   .87407217   .85104744   .85839444  -.04825507   .18715851  -1.2456107
    ul   1.1150996   1.0570678   1.0524514   .21670387   .25757802  -1.0733412
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

. 
. cap noi drop pred

. regress x z1 z2 z3 if _n <= 250

      Source |       SS           df       MS      Number of obs   =       250
-------------+----------------------------------   F(3, 246)       =     28.81
       Model |   246.64769         3  82.2158965   Prob > F        =    0.0000
    Residual |  701.939562       246  2.85341285   R-squared       =    0.2600
-------------+----------------------------------   Adj R-squared   =    0.2510
       Total |  948.587252       249  3.80958736   Root MSE        =    1.6892

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9174599   .1841768     4.98   0.000     .5546953    1.280224
          z2 |   1.066763   .1764941     6.04   0.000     .7191307    1.414395
          z3 |   .9295532   .1622004     5.73   0.000     .6100745    1.249032
       _cons |   .0817864   .2144483     0.38   0.703    -.3406025    .5041754
------------------------------------------------------------------------------

. predict pred if _n <= 250
(option xb assumed; fitted values)
(2,250 missing values generated)

. glm y pred if _n <= 250, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =        250
Optimization     : ML                             Residual df     =        248
                                                  Scale parameter =   1.040361
Deviance         =  78.01503952                   (1/df) Deviance =   .3145768
Pearson          =  258.0095851                   (1/df) Pearson  =   1.040361

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .6363156
Log likelihood   =  -77.5394559                   BIC             =  -1291.307

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        pred |   .2041119   .0661871     3.08   0.002     .0743875    .3338362
       _cons |  -1.054149   .1345992    -7.83   0.000    -1.317959   -.7903395
------------------------------------------------------------------------------

. scalar lmrr2 = _b[pred]

. scalar selmrr2 = _se[pred]

. ivtsps y (x = z1 z2 z3) if _n <= 250, link(logmult)

Final GMM criterion Q(b) =  2.06e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        250

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9174599   .1730034     5.30   0.000     .5783795     1.25654
    /s1xb_z2 |   1.066763   .1765785     6.04   0.000     .7206756    1.412851
    /s1xb_z3 |   .9295532   .1660914     5.60   0.000     .6040201    1.255086
         /a0 |   .0817864   .2035786     0.40   0.688    -.3172202    .4807931
         /b1 |   .2041119   .0538512     3.79   0.000     .0985655    .3096582
         /b0 |  -1.054149   .1263154    -8.35   0.000    -1.301723   -.8065755
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.226435    .066045     3.79   0.000     1.103587    1.362959
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr2)) < 2e-2

. 
. cap noi drop pred

. regress x z1 z2 z3 w

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. glm y pred w, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =      2,500
Optimization     : ML                             Residual df     =      2,497
                                                  Scale parameter =   1.911145
Deviance         =  1290.467158                   (1/df) Deviance =    .516807
Pearson          =  4772.130176                   (1/df) Pearson  =   1.911145

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .1869441
Log likelihood   = -230.6801555                   BIC             =  -18246.18

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        pred |    .307442    .028211    10.90   0.000     .2521495    .3627345
           w |   .3482615   .0392281     8.88   0.000     .2713757    .4251472
       _cons |  -1.481904   .0577018   -25.68   0.000    -1.594998   -1.368811
------------------------------------------------------------------------------

. scalar lmrr3 = _b[pred]

. scalar selmrr3 = _se[pred]

. ivtsps y w (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  1.89e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |    .307442   .0271383    11.33   0.000     .2542519    .3606321
 /s2exogxb_w |   .3482615   .0360076     9.67   0.000     .2776879    .4188351
         /b0 |  -1.481904   .0640343   -23.14   0.000    -1.607409   -1.356399
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.359942   .0369065    11.33   0.000     1.289497    1.434236
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logmult) estonly

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lmrr1)) < 1e-2

. 
. // logit link
. 
. cap noi drop pred

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. logit y pred, nolog

Logistic regression                                     Number of obs =  2,500
                                                        LR chi2(1)    = 127.30
                                                        Prob > chi2   = 0.0000
Log likelihood = -1667.8059                             Pseudo R2     = 0.0368

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        pred |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. scalar lor1 = _b[pred]

. scalar selor1 = _se[pred]

. ivtsps y (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  6.99e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4488332   .0346899    12.94   0.000     .3808424    .5168241
         /b0 |  -.8868145   .0715273   -12.40   0.000    -1.027006   -.7466235
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.566483   .0543411    12.94   0.000     1.463517    1.676694
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4488332   .0346899    12.94   0.000     .3808424    .5168241
         /b0 |  -.8868145   .0715273   -12.40   0.000    -1.027006   -.7466235
------------------------------------------------------------------------------

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.566483   .0543411    12.94   0.000     1.463517    1.676694
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor1)) < 1e-2

. mat list r(table)

r(table)[9,6]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b0:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .44883323  -.88681454
    se   .06148771   .05255718   .04950525   .06759281   .03468986   .07152734
     z    16.17536   18.152756   19.299427   1.2460557   12.938458  -12.398259
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   2.731e-38   2.671e-35
    ll   .87407217   .85104744   .85839444  -.04825507   .38084237  -1.0270056
    ul   1.1150996   1.0570678   1.0524514   .21670387    .5168241  -.74662353
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

. 
. cap noi drop pred

. regress x z1 z2 z3 if _n <= 100

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     11.91
       Model |  122.239349         3  40.7464497   Prob > F        =    0.0000
    Residual |  328.524824        96  3.42213358   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2484
       Total |  450.764173        99  4.55317346   Root MSE        =    1.8499

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |    .820003   .3207528     2.56   0.012     .1833137    1.456692
          z2 |    1.41933   .3039049     4.67   0.000     .8160838    2.022577
          z3 |    .920567   .2938893     3.13   0.002     .3372012    1.503933
       _cons |  -.3875989    .404343    -0.96   0.340    -1.190214    .4150156
------------------------------------------------------------------------------

. predict pred if _n <= 100
(option xb assumed; fitted values)
(2,400 missing values generated)

. logit y pred if _n <= 100, nolog

Logistic regression                                     Number of obs =    100
                                                        LR chi2(1)    =   8.11
                                                        Prob > chi2   = 0.0044
Log likelihood = -65.239727                             Pseudo R2     = 0.0585

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        pred |   .5496075   .2053162     2.68   0.007     .1471951    .9520198
       _cons |  -.9312613   .3910448    -2.38   0.017    -1.697695   -.1648277
------------------------------------------------------------------------------

. scalar lor2 = _b[pred]

. scalar selor2 = _se[pred]

. ivtsps y (x = z1 z2 z3) if _n <= 100, link(logit)

Final GMM criterion Q(b) =  2.67e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .820003   .3089263     2.65   0.008     .2145185    1.425487
    /s1xb_z2 |    1.41933   .3008394     4.72   0.000     .8296958    2.008964
    /s1xb_z3 |    .920567   .3021418     3.05   0.002       .32838    1.512754
         /a0 |  -.3875989   .3651993    -1.06   0.289    -1.103376    .3281786
         /b1 |   .5496075   .1497189     3.67   0.000     .2561639    .8430511
         /b0 |  -.9312614    .276238    -3.37   0.001    -1.472678   -.3898448
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.732573   .2593988     3.67   0.000     1.291965    2.323445
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor2)) < 1e-1

. 
. cap noi drop pred

. regress x w z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. logit y w pred, nolog

Logistic regression                                     Number of obs =  2,500
                                                        LR chi2(2)    = 706.55
                                                        Prob > chi2   = 0.0000
Log likelihood = -1378.1819                             Pseudo R2     = 0.2040

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           w |   .6330367   .0669263     9.46   0.000     .5018636    .7642098
        pred |   .5740638   .0482844    11.89   0.000     .4794282    .6686995
       _cons |  -1.149458   .0981749   -11.71   0.000    -1.341878    -.957039
------------------------------------------------------------------------------

. scalar lor3 = _b[pred]

. scalar selor3 = _se[pred]

. ivtsps y w (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  1.57e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .5740639   .0434765    13.20   0.000     .4888515    .6592762
 /s2exogxb_w |   .6330367   .0597833    10.59   0.000     .5158637    .7502098
         /b0 |  -1.149458   .0870355   -13.21   0.000    -1.320045   -.9788718
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.775468   .0771911    13.20   0.000     1.630443    1.933392
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logit) estonly

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lor1)) < 1e-2

. 
. // check errors
. 
. rcof "noi ivtsps y w (x1 x2 = z1 z2 z3)" == 198
Currently, only 1 endogenous variable is allowed
invalid syntax

. 
. // preditced varname test
. 
. cap noi drop predicted
variable predicted not found

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict predicted
(option xb assumed; fitted values)

. regress y predicted

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =    130.88
       Model |  31.0797477         1  31.0797477   Prob > F        =    0.0000
    Residual |  593.214652     2,498  .237475842   R-squared       =    0.0498
-------------+----------------------------------   Adj R-squared   =    0.0494
       Total |    624.2944     2,499  .249817687   Root MSE        =    .48731

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. scalar bx4 = _b[predicted]

. replace predicted = _n in 1/3
(3 real changes made)

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. | 1.038282 |
  5. | 1.038282 |
     +----------+

. ivtsps y (x = z1 z2 z3)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. | 1.038282 |
  5. | 1.038282 |
     +----------+

. 
. cap noi drop predicted

. regress x z1 z2 z3 in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     14.95
       Model |  111.112814         3  37.0376048   Prob > F        =    0.0000
    Residual |   237.89687        96   2.4780924   R-squared       =    0.3184
-------------+----------------------------------   Adj R-squared   =    0.2971
       Total |  349.009685        99  3.52535035   Root MSE        =    1.5742

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |    .969467   .2557025     3.79   0.000     .4619016    1.477032
          z2 |   .7058939   .2623521     2.69   0.008     .1851291    1.226659
          z3 |   1.322028    .243232     5.44   0.000     .8392159    1.804839
       _cons |    .133577   .3190074     0.42   0.676    -.4996476    .7668016
------------------------------------------------------------------------------

. predict predicted in 101/200
(option xb assumed; fitted values)
(2,400 missing values generated)

. regress y predicted in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(1, 98)        =      3.47
       Model |   .84312816         1   .84312816   Prob > F        =    0.0654
    Residual |  23.7968718        98  .242825223   R-squared       =    0.0342
-------------+----------------------------------   Adj R-squared   =    0.0244
       Total |       24.64        99  .248888889   Root MSE        =    .49277

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .0871093   .0467482     1.86   0.065    -.0056609    .1798796
       _cons |   .3906352   .1033901     3.78   0.000     .1854608    .5958095
------------------------------------------------------------------------------

. scalar bx4 = _b[predicted]

. replace predicted = _n in 1/3
(3 real changes made)

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. ivtsps y (x = z1 z2 z3) in 101/200

Final GMM criterion Q(b) =  1.09e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .969467   .2259696     4.29   0.000     .5265747    1.412359
    /s1xb_z2 |   .7058939   .2698506     2.62   0.009     .1769965    1.234791
    /s1xb_z3 |   1.322028   .2210988     5.98   0.000     .8886818    1.755373
         /a0 |    .133577   .3267649     0.41   0.683    -.5068705    .7740245
         /b1 |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
         /b0 |   .3906352   .0815149     4.79   0.000     .2308689    .5504014
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. 
. bootstrap, reps(250): ivtsps y (x = z1 z2 z3), estonly
(running ivtsps on estimation sample)

Bootstrap replications (250): .........10.........20.........30.........40.....
> ....50.........60.........70.........80.........90.........100.........110...
> ......120.........130.........140.........150.........160.........170........
> .180.........190.........200.........210.........220.........230.........240.
> ........250 done

------------------------------------------------------------------------------
             |   Observed   Bootstrap                         Normal-based
           y | coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019    .007757    13.79   0.000     .0917986    .1222053
       _cons |   .2879917    .016084    17.91   0.000     .2564677    .3195156
------------------------------------------------------------------------------

. 
end of do-file
      name:  ivtsps
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsps.log
  log type:  text
 closed on:   1 May 2025, 21:27:28
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivtsri
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsri.log
  log type:  text
 opened on:   1 May 2025, 21:27:28

. // ivtsri cscript
. // 2021-09-06
. 
. cscript ivtsri adofiles ivtsri
-------------------------------------------------------------------BEGIN ivtsri

-> which ivtsri, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivtsri.ado
*! 1.0.0 Tom Palmer 05sep2021

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. // identity link
. 
. ivregress gmm y (x = z1 z2 z3)

Instrumental-variables GMM regression             Number of obs   =      2,500
                                                  Wald chi2(1)    =     207.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.3690
GMM weight matrix: Robust                         Root MSE        =     .39694

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1071817   .0074402    14.41   0.000     .0925993    .1217642
       _cons |   .2879039   .0157363    18.30   0.000     .2570612    .3187465
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar bx1 = _b[x]

. scalar sx1 = _se[x]

. estat endog

  Test of endogeneity (orthogonality conditions)
  H0: Variables are exogenous

  GMM C statistic chi2(1) =  67.6905  (p = 0.0000)

. scalar endogteststat = r(C)

. ivtsri y (x = z1 z2 z3)

Final GMM criterion Q(b) =  6.99e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b2 |   .0740544    .009023     8.21   0.000     .0563696    .0917393
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0740544    .009023     8.21   0.000     .0563696    .0917393
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b2 |   .0740544    .009023     8.21   0.000     .0563696    .0917393
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0740544    .009023     8.21   0.000     .0563696    .0917393
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. assert abs((_b[b2:_cons] / _se[b2:_cons])^2 - scalar(endogteststat)) < 1e0

. mat list r(table)

r(table)[9,7]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b2:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .10700195   .07405445
    se   .06148771   .05255718   .04950525   .06759281   .00744244   .00902303
     z    16.17536   18.152756   19.299427   1.2460557   14.377259   8.2072734
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   7.189e-47   2.263e-16
    ll   .87407217   .85104744   .85839444  -.04825507   .09241503   .05636964
    ul   1.1150996   1.0570678   1.0524514   .21670387   .12158887   .09173926
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

                b0:
             _cons
     b   .28799166
    se    .0157401
     z    18.29668
pvalue   8.795e-75
    ll   .25714162
    ul   .31884169
    df           .
  crit    1.959964
 eform           0

. 
. ivregress gmm y (x = z1 z2 z3) if _n <= 50

Instrumental-variables GMM regression             Number of obs   =         50
                                                  Wald chi2(1)    =      36.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.5501
GMM weight matrix: Robust                         Root MSE        =     .33512

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1781062   .0294317     6.05   0.000     .1204211    .2357912
       _cons |   .2258489   .0642993     3.51   0.000     .0998245    .3518732
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar bx2 = _b[x]

. scalar sx2 = _se[x]

. ivtsri y (x = z1 z2 z3) if _n <= 50

Final GMM criterion Q(b) =  1.43e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =         50

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   1.060589   .3962486     2.68   0.007     .2839558    1.837222
    /s1xb_z2 |   1.148148   .3925519     2.92   0.003     .3787603    1.917535
    /s1xb_z3 |   1.403546   .3177779     4.42   0.000      .780713    2.026379
         /a0 |  -.5013724   .3595452    -1.39   0.163    -1.206068    .2033233
         /b1 |      .1713   .0290798     5.89   0.000     .1143046    .2282954
         /b2 |   .0036814    .039025     0.09   0.925    -.0728061    .0801689
         /b0 |   .2434077   .0653369     3.73   0.000     .1153498    .3714656
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |      .1713   .0290798     5.89   0.000     .1143046    .2282954
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0036814    .039025     0.09   0.925    -.0728061    .0801689
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx2)) < 1e-3

. 
. ivtsri y (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  6.99e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b2 |   .0740544    .009023     8.21   0.000     .0563696    .0917393
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0740544    .009023     8.21   0.000     .0563696    .0917393
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. 
. ivregress gmm y w (x = z1 z2 z3)

Instrumental-variables GMM regression             Number of obs   =      2,500
                                                  Wald chi2(2)    =    1628.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.4202
GMM weight matrix: Robust                         Root MSE        =     .38051

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1054227   .0073416    14.36   0.000     .0910334     .119812
           w |   .1159165    .010589    10.95   0.000     .0951624    .1366707
       _cons |   .2865861   .0150723    19.01   0.000     .2570449    .3161273
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  w z1 z2 z3

. scalar bx3 = _b[x]

. scalar sx3 = _se[x]

. ivtsri y w (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  1.29e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   9
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
         /b2 |   .0545595   .0092853     5.88   0.000     .0363606    .0727584
 /s2exogxb_w |   .1160821   .0105911    10.96   0.000     .0953239    .1368403
         /b0 |   .2867508   .0150764    19.02   0.000     .2572016       .3163
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: x residuals w _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0545595   .0092853     5.88   0.000     .0363606    .0727584
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx3)) < 1e-3

. 
. ivtsri y (x = z1 z2 z3), estonly

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1070019   .0072277    14.80   0.000      .092829    .1211749
   residuals |   .0740544   .0084664     8.75   0.000     .0574525    .0906564
       _cons |   .2879917   .0151852    18.97   0.000     .2582148    .3177685
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1070019   .0072277    14.80   0.000      .092829    .1211749
   residuals |   .0740544   .0084664     8.75   0.000     .0574525    .0906564
       _cons |   .2879917   .0151852    18.97   0.000     .2582148    .3177685
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(bx1)) < 1e-2

. 
. // logadd link
. 
. cap noi drop res
variable res not found

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict double res, res

. poisson y x res, nolog

Poisson regression                                      Number of obs =  2,500
                                                        LR chi2(2)    = 552.27
                                                        Prob > chi2   = 0.0000
Log likelihood = -1810.4754                             Pseudo R2     = 0.1323

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |    .204947   .0264587     7.75   0.000      .153089     .256805
         res |    .165149   .0316964     5.21   0.000     .1030252    .2272729
       _cons |  -1.326536   .0639398   -20.75   0.000    -1.451855   -1.201216
------------------------------------------------------------------------------

. scalar larr1 = _b[x]

. scalar selarr1 = _se[x]

. ivtsri y (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  1.10e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |    .204947   .0167534    12.23   0.000     .1721109    .2377831
         /b2 |   .1651491   .0197853     8.35   0.000     .1263706    .2039275
         /b0 |  -1.326536   .0446685   -29.70   0.000    -1.414084   -1.238987
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    1.22746   .0205641    12.23   0.000      1.18781    1.268434
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.179569   .0233381     8.35   0.000     1.134703    1.226209
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |    .204947   .0167534    12.23   0.000     .1721109    .2377831
         /b2 |   .1651491   .0197853     8.35   0.000     .1263706    .2039275
         /b0 |  -1.326536   .0446685   -29.70   0.000    -1.414084   -1.238987
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    1.22746   .0205641    12.23   0.000      1.18781    1.268434
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.179569   .0233381     8.35   0.000     1.134703    1.226209
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(larr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selarr1)) < 1e-2

. mat list r(table)

r(table)[9,7]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b2:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .20494699   .16514905
    se   .06148771   .05255718   .04950525   .06759281   .01675341   .01978531
     z    16.17536   18.152756   19.299427   1.2460557   12.233151   8.3470547
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   2.068e-34   6.999e-17
    ll   .87407217   .85104744   .85839444  -.04825507   .17211091   .12637056
    ul   1.1150996   1.0570678   1.0524514   .21670387   .23778307   .20392755
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

                b0:
             _cons
     b  -1.3265358
    se   .04466852
     z  -29.697332
pvalue   8.31e-194
    ll  -1.4140844
    ul  -1.2389871
    df           .
  crit    1.959964
 eform           0

. 
. cap noi drop res

. regress x z1 z2 z3 if _n <= 200

      Source |       SS           df       MS      Number of obs   =       200
-------------+----------------------------------   F(3, 196)       =     23.42
       Model |  212.415301         3  70.8051002   Prob > F        =    0.0000
    Residual |  592.447131       196  3.02268944   R-squared       =    0.2639
-------------+----------------------------------   Adj R-squared   =    0.2526
       Total |  804.862431       199  4.04453483   Root MSE        =    1.7386

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |    .960665   .2046653     4.69   0.000     .5570362    1.364294
          z2 |   1.017943   .2013996     5.05   0.000      .620755    1.415132
          z3 |   1.105939   .1918124     5.77   0.000     .7276577     1.48422
       _cons |  -.1036275   .2577458    -0.40   0.688    -.6119386    .4046836
------------------------------------------------------------------------------

. predict double res if _n <= 200, res
(2,300 missing values generated)

. poisson y x res if _n <= 200, nolog

Poisson regression                                      Number of obs =    200
                                                        LR chi2(2)    =  42.88
                                                        Prob > chi2   = 0.0000
Log likelihood = -151.21931                             Pseudo R2     = 0.1242

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .2241425   .0872348     2.57   0.010     .0531655    .3951195
         res |   .1423872   .1026672     1.39   0.165    -.0588368    .3436111
       _cons |  -1.260957   .2150672    -5.86   0.000    -1.682481   -.8394332
------------------------------------------------------------------------------

. scalar larr2 = _b[x]

. scalar selarr2 = _se[x]

. ivtsri y (x = z1 z2 z3) if _n <= 200, link(logadd)

Final GMM criterion Q(b) =  1.19e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =        200

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .960665   .1863621     5.15   0.000      .595402    1.325928
    /s1xb_z2 |   1.017943   .1993872     5.11   0.000     .6271518    1.408735
    /s1xb_z3 |   1.105939   .1977604     5.59   0.000     .7183356    1.493542
         /a0 |  -.1036275   .2498245    -0.41   0.678    -.5932745    .3860195
         /b1 |   .2241425   .0467658     4.79   0.000     .1324832    .3158019
         /b2 |   .1423872   .0539735     2.64   0.008      .036601    .2481733
         /b0 |  -1.260957   .1392786    -9.05   0.000    -1.533938    -.987976
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.251249   .0585157     4.79   0.000      1.14166    1.371359
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.153023   .0622327     2.64   0.008     1.037279    1.281682
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(larr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selarr2)) < 1e-1

. 
. cap noi drop res

. regress x z1 z2 z3 w

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict double res, res

. poisson y x res w, nolog

Poisson regression                                      Number of obs =  2,500
                                                        LR chi2(3)    = 565.02
                                                        Prob > chi2   = 0.0000
Log likelihood = -1804.0989                             Pseudo R2     = 0.1354

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .2005151   .0268895     7.46   0.000     .1478127    .2532175
         res |   .1272374    .034081     3.73   0.000     .0604399    .1940348
           w |   .2483673    .039375     6.31   0.000     .1711938    .3255409
       _cons |  -1.332769   .0638056   -20.89   0.000    -1.457825   -1.207712
------------------------------------------------------------------------------

. scalar larr3 = _b[x]

. scalar selarr3 = _se[x]

. ivtsri y w (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  1.66e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   9
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .2005151   .0166767    12.02   0.000     .1678294    .2332007
         /b2 |   .1272374   .0204528     6.22   0.000     .0871507    .1673241
 /s2exogxb_w |   .2483674   .0243529    10.20   0.000     .2006365    .2960982
         /b0 |  -1.332769   .0428083   -31.13   0.000    -1.416671   -1.248866
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: x residuals w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.222032   .0203794    12.02   0.000     1.182735    1.262635
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.135687    .023228     6.22   0.000     1.091061    1.182137
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(larr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selarr3)) < 5e-2

. 
. ivtsri y (x = z1 z2 z3), link(logadd) estonly

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |    .204947   .0264587     7.75   0.000      .153089     .256805
   residuals |   .1651491   .0316964     5.21   0.000     .1030253    .2272729
       _cons |  -1.326536   .0639398   -20.75   0.000    -1.451855   -1.201216
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |    .204947   .0264587     7.75   0.000      .153089     .256805
   residuals |   .1651491   .0316964     5.21   0.000     .1030253    .2272729
       _cons |  -1.326536   .0639398   -20.75   0.000    -1.451855   -1.201216
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(larr1)) < 1e-2

. 
. // logmult link
. 
. ivpoisson cfunction y (x = z1 z2 z3), nolog

Final GMM criterion Q(b) =  4.91e-20

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   7                         Number of obs  =      2,500
Number of moments    =   7
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
y            |
           x |   .4135643   .0456204     9.07   0.000     .3241499    .5029786
       _cons |  -1.914564   .1100322   -17.40   0.000    -2.130223   -1.698905
-------------+----------------------------------------------------------------
x            |
          z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
          z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
          z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
       _cons |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
-------------+----------------------------------------------------------------
        /c_x |   .3079003   .0455426     6.76   0.000     .2186384    .3971621
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar lmrr1 = _b[x]

. scalar selmrr1 = _se[x]

. ivtsri y (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  2.70e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4135643   .0456204     9.07   0.000     .3241499    .5029786
         /b2 |   .3079002   .0455426     6.76   0.000     .2186384    .3971621
         /b0 |  -1.914564   .1100322   -17.40   0.000    -2.130223   -1.698905
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.512198   .0689871     9.07   0.000     1.382855     1.65364
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.360565   .0619637     6.76   0.000     1.244381    1.487597
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4135643   .0456204     9.07   0.000     .3241499    .5029786
         /b2 |   .3079002   .0455426     6.76   0.000     .2186384    .3971621
         /b0 |  -1.914564   .1100322   -17.40   0.000    -2.130223   -1.698905
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.512198   .0689871     9.07   0.000     1.382855     1.65364
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.360565   .0619637     6.76   0.000     1.244381    1.487597
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr1)) < 1e-2

. mat list r(table)

r(table)[9,7]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b2:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .41356426   .30790025
    se   .06148771   .05255718   .04950525   .06759281   .04562041    .0455426
     z    16.17536   18.152756   19.299427   1.2460557   9.0653341   6.7607082
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   1.242e-19   1.373e-11
    ll   .87407217   .85104744   .85839444  -.04825507    .3241499   .21863839
    ul   1.1150996   1.0570678   1.0524514   .21670387   .50297862   .39716211
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

                b0:
             _cons
     b  -1.9145637
    se   .11003215
     z  -17.400039
pvalue   8.245e-68
    ll  -2.1302227
    ul  -1.6989046
    df           .
  crit    1.959964
 eform           0

. 
. ivpoisson cfunction y (x = z1 z2 z3) if _n <= 250, nolog

Final GMM criterion Q(b) =  1.57e-21

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   7                         Number of obs  =        250
Number of moments    =   7
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
y            |
           x |   .4199621   .1143385     3.67   0.000     .1958627    .6440615
       _cons |  -1.764816   .2759322    -6.40   0.000    -2.305633   -1.223999
-------------+----------------------------------------------------------------
x            |
          z1 |   .9174599   .1730034     5.30   0.000     .5783795     1.25654
          z2 |   1.066763   .1765785     6.04   0.000     .7206756    1.412851
          z3 |   .9295532   .1660914     5.60   0.000     .6040201    1.255086
       _cons |   .0817864   .2035786     0.40   0.688    -.3172202    .4807931
-------------+----------------------------------------------------------------
        /c_x |   .1639146   .1218836     1.34   0.179    -.0749729    .4028022
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  z1 z2 z3

. scalar lmrr2 = _b[x]

. scalar selmrr2 = _se[x]

. ivtsri y (x = z1 z2 z3) if _n <= 250, link(logmult)

Final GMM criterion Q(b) =  8.97e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =        250

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9174599   .1730034     5.30   0.000     .5783795     1.25654
    /s1xb_z2 |   1.066763   .1765785     6.04   0.000     .7206756    1.412851
    /s1xb_z3 |   .9295532   .1660914     5.60   0.000     .6040201    1.255086
         /a0 |   .0817864   .2035786     0.40   0.688    -.3172202    .4807931
         /b1 |   .4199621   .1143385     3.67   0.000     .1958627    .6440615
         /b2 |   .1639146   .1218836     1.34   0.179     -.074973    .4028022
         /b0 |  -1.764816   .2759322    -6.40   0.000    -2.305633   -1.223999
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.521904   .1740122     3.67   0.000      1.21636    1.904199
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.178114   .1435928     1.34   0.179     .9277686    1.496011
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr2)) < 1e-2

. 
. ivpoisson cfunction y w (x = z1 z2 z3), nolog

Final GMM criterion Q(b) =  6.86e-20

note: model is exactly identified.

Exponential mean model with endogenous regressors

Number of parameters =   9                         Number of obs  =      2,500
Number of moments    =   9
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
y            |
           w |   .5565686   .0578091     9.63   0.000     .4432648    .6698724
           x |   .4399661   .0476861     9.23   0.000     .3465031    .5334291
       _cons |  -2.019925   .1126677   -17.93   0.000    -2.240749     -1.7991
-------------+----------------------------------------------------------------
x            |
           w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
          z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
          z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
          z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
       _cons |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
-------------+----------------------------------------------------------------
        /c_x |   .2131522   .0477597     4.46   0.000     .1195449    .3067596
------------------------------------------------------------------------------
Endogenous: x
Exogenous:  w z1 z2 z3

. scalar lmrr3 = _b[x]

. scalar selmrr3 = _se[x]

. ivtsri y w (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  5.89e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   9
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .4399661   .0476861     9.23   0.000     .3465031    .5334291
         /b2 |   .2131522   .0477597     4.46   0.000     .1195449    .3067596
 /s2exogxb_w |   .5565686   .0578091     9.63   0.000     .4432648    .6698724
         /b0 |  -2.019925   .1126677   -17.93   0.000    -2.240749     -1.7991
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: x residuals w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.552655     .07404     9.23   0.000     1.414114    1.704768
------------------------------------------------------------------------------

Causal risk ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.237573   .0591062     4.46   0.000     1.126984    1.359014
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr3)) < 1e-2

. 
. ivtsri y (x = z1 z2 z3), link(logmult) estonly

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .4135643   .0394492    10.48   0.000     .3362452    .4908833
   residuals |   .3079002   .0450075     6.84   0.000     .2196871    .3961134
       _cons |  -1.914564   .0820983   -23.32   0.000    -2.075473   -1.753654
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |                 OIM
           y | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .4135643   .0394492    10.48   0.000     .3362452    .4908833
   residuals |   .3079002   .0450075     6.84   0.000     .2196871    .3961134
       _cons |  -1.914564   .0820983   -23.32   0.000    -2.075473   -1.753654
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lmrr1)) < 1e-2

. 
. // logit link
. 
. cap noi drop res

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict double res, res

. logit y x res, nolog

Logistic regression                                    Number of obs =   2,500
                                                       LR chi2(2)    = 1462.29
                                                       Prob > chi2   =  0.0000
Log likelihood = -1000.3111                            Pseudo R2     =  0.4223

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .8518266   .0605198    14.08   0.000     .7332099    .9704432
         res |   .5726491   .0649931     8.81   0.000     .4452651    .7000332
       _cons |  -1.675875   .1247897   -13.43   0.000    -1.920458   -1.431292
------------------------------------------------------------------------------

. scalar lor1 = _b[x]

. scalar selor1 = _se[x]

. ivtsri y (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  6.85e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .8518266   .0648163    13.14   0.000      .724789    .9788641
         /b2 |   .5726491   .0694512     8.25   0.000     .4365273    .7087709
         /b0 |  -1.675875    .133441   -12.56   0.000    -1.937415   -1.414336
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.343924   .1519244    13.14   0.000     2.064296    2.661431
------------------------------------------------------------------------------

Causal odds ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.772958    .123134     8.25   0.000     1.547325    2.031493
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .8518266   .0648163    13.14   0.000      .724789    .9788641
         /b2 |   .5726491   .0694512     8.25   0.000     .4365273    .7087709
         /b0 |  -1.675875    .133441   -12.56   0.000    -1.937415   -1.414336
------------------------------------------------------------------------------

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.343924   .1519244    13.14   0.000     2.064296    2.661431
------------------------------------------------------------------------------

Causal odds ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.772958    .123134     8.25   0.000     1.547325    2.031493
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor1)) < 1e-2

. mat list r(table)

r(table)[9,7]
           s1xb_z1:    s1xb_z2:    s1xb_z3:         a0:         b1:         b2:
             _cons       _cons       _cons       _cons       _cons       _cons
     b   .99458587   .95405762   .95542294    .0842244   .85182657   .57264911
    se   .06148771   .05255718   .04950525   .06759281   .06481626   .06945116
     z    16.17536   18.152756   19.299427   1.2460557   13.142173   8.2453504
pvalue   7.526e-59   1.221e-73   5.431e-83   .21274396   1.887e-39   1.647e-16
    ll   .87407217   .85104744   .85839444  -.04825507   .72478903   .43652735
    ul   1.1150996   1.0570678   1.0524514   .21670387   .97886411   .70877088
    df           .           .           .           .           .           .
  crit    1.959964    1.959964    1.959964    1.959964    1.959964    1.959964
 eform           0           0           0           0           0           0

                b0:
             _cons
     b  -1.6758752
    se   .13344103
     z   -12.55892
pvalue   3.551e-36
    ll  -1.9374148
    ul  -1.4143356
    df           .
  crit    1.959964
 eform           0

. 
. cap noi drop res

. regress x z1 z2 z3 if _n <= 100

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     11.91
       Model |  122.239349         3  40.7464497   Prob > F        =    0.0000
    Residual |  328.524824        96  3.42213358   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2484
       Total |  450.764173        99  4.55317346   Root MSE        =    1.8499

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |    .820003   .3207528     2.56   0.012     .1833137    1.456692
          z2 |    1.41933   .3039049     4.67   0.000     .8160838    2.022577
          z3 |    .920567   .2938893     3.13   0.002     .3372012    1.503933
       _cons |  -.3875989    .404343    -0.96   0.340    -1.190214    .4150156
------------------------------------------------------------------------------

. predict double res if _n <= 100, res
(2,400 missing values generated)

. logit y x res if _n <= 100, nolog

Logistic regression                                     Number of obs =    100
                                                        LR chi2(2)    =  76.51
                                                        Prob > chi2   = 0.0000
Log likelihood = -31.040038                             Pseudo R2     = 0.5521

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   1.078734   .3518077     3.07   0.002     .3892034    1.768264
         res |   .6217428   .3802096     1.64   0.102    -.1234544     1.36694
       _cons |  -1.790935   .6585132    -2.72   0.007    -3.081597   -.5002725
------------------------------------------------------------------------------

. scalar lor2 = _b[x]

. scalar selor2 = _se[x]

. ivtsri y (x = z1 z2 z3) if _n <= 100, link(logit)

Final GMM criterion Q(b) =  2.27e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .820003   .3089263     2.65   0.008     .2145185    1.425487
    /s1xb_z2 |    1.41933   .3008394     4.72   0.000     .8296958    2.008964
    /s1xb_z3 |    .920567   .3021418     3.05   0.002       .32838    1.512754
         /a0 |  -.3875989   .3651993    -1.06   0.289    -1.103376    .3281786
         /b1 |   1.078734   .3247226     3.32   0.001     .4422894    1.715178
         /b2 |   .6217428   .3530592     1.76   0.078    -.0702404    1.313726
         /b0 |  -1.790935   .6476516    -2.77   0.006    -3.060309   -.5215611
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.940954   .9549941     3.32   0.001     1.556266    5.557667
------------------------------------------------------------------------------

Causal odds ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.862171   .6574564     1.76   0.078     .9321697    3.720009
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor2)) < 5e-2

. 
. cap noi drop res

. regress x z1 z2 z3 w

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict double res, res

. logit y x res w, nolog

Logistic regression                                    Number of obs =   2,500
                                                       LR chi2(3)    = 1523.18
                                                       Prob > chi2   =  0.0000
Log likelihood = -969.8676                             Pseudo R2     =  0.4399

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .8813906   .0628047    14.03   0.000     .7582957    1.004486
         res |   .4189215   .0696737     6.01   0.000     .2823637    .5554794
           w |   .9615452   .0849258    11.32   0.000     .7950937    1.127997
       _cons |  -1.771829   .1283181   -13.81   0.000    -2.023328   -1.520331
------------------------------------------------------------------------------

. scalar lor3 = _b[x]

. scalar selor3 = _se[x]

. ivtsri y w (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  1.29e-32

note: model is exactly identified.

GMM estimation 

Number of parameters =   9
Number of moments    =   9
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .8813906   .0655926    13.44   0.000     .7528315     1.00995
         /b2 |   .4189215   .0731088     5.73   0.000      .275631    .5622121
 /s2exogxb_w |   .9615452   .0879674    10.93   0.000     .7891322    1.133958
         /b0 |  -1.771829   .1332013   -13.30   0.000    -2.032899    -1.51076
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: x residuals w _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   2.414255   .1583572    13.44   0.000     2.123003    2.745463
------------------------------------------------------------------------------

Causal odds ratio for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   1.520321   .1111488     5.73   0.000     1.317362    1.754549
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor3)) < 1e-2

. 
. ivtsri y (x = z1 z2 z3), link(logit) estonly

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .8518266   .0605198    14.08   0.000       .73321    .9704431
   residuals |   .5726491    .064993     8.81   0.000     .4452651    .7000331
       _cons |  -1.675875   .1247896   -13.43   0.000    -1.920458   -1.431292
------------------------------------------------------------------------------

. ivtsri

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .8518266   .0605198    14.08   0.000       .73321    .9704431
   residuals |   .5726491    .064993     8.81   0.000     .4452651    .7000331
       _cons |  -1.675875   .1247896   -13.43   0.000    -1.920458   -1.431292
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lor1)) < 1e-2

. 
. // check errors
. 
. rcof "noi ivtsri y w (x1 x2 = z1 z2 z3)" == 198
Currently, only 1 endogenous variable is allowed
invalid syntax

. 
. // residuals varname test
. 
. cap noi drop residuals
variable residuals not found

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict residuals, residuals

. regress y x residuals

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(2, 2497)      =    952.71
       Model |  270.201632         2  135.100816   Prob > F        =    0.0000
    Residual |  354.092768     2,497  .141807276   R-squared       =    0.4328
-------------+----------------------------------   Adj R-squared   =    0.4324
       Total |    624.2944     2,499  .249817687   Root MSE        =    .37657

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1070019   .0072277    14.80   0.000      .092829    .1211749
   residuals |   .0740544   .0084664     8.75   0.000     .0574525    .0906564
       _cons |   .2879917   .0151852    18.97   0.000     .2582148    .3177685
------------------------------------------------------------------------------

. scalar bx4 = _b[x]

. scalar sx4 = _se[x]

. scalar bxr = _b[residuals]

. scalar sxr = _se[residuals]

. replace residuals = _n in 1/3
(3 real changes made)

. list residuals in 1/5

     +-----------+
     | residuals |
     |-----------|
  1. |         1 |
  2. |         2 |
  3. |         3 |
  4. | -.8104355 |
  5. | -.2642797 |
     +-----------+

. ivtsri y (x = z1 z2 z3)

Final GMM criterion Q(b) =  6.99e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b2 |   .0740544    .009023     8.21   0.000     .0563696    .0917393
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0740544    .009023     8.21   0.000     .0563696    .0917393
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. assert abs(_b[b2:_cons] - scalar(bxr)) < 1e-2

. list residuals in 1/5

     +-----------+
     | residuals |
     |-----------|
  1. |         1 |
  2. |         2 |
  3. |         3 |
  4. | -.8104355 |
  5. | -.2642797 |
     +-----------+

. 
. cap noi drop residuals

. regress x z1 z2 z3 in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     14.95
       Model |  111.112814         3  37.0376048   Prob > F        =    0.0000
    Residual |   237.89687        96   2.4780924   R-squared       =    0.3184
-------------+----------------------------------   Adj R-squared   =    0.2971
       Total |  349.009685        99  3.52535035   Root MSE        =    1.5742

------------------------------------------------------------------------------
           x | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          z1 |    .969467   .2557025     3.79   0.000     .4619016    1.477032
          z2 |   .7058939   .2623521     2.69   0.008     .1851291    1.226659
          z3 |   1.322028    .243232     5.44   0.000     .8392159    1.804839
       _cons |    .133577   .3190074     0.42   0.676    -.4996476    .7668016
------------------------------------------------------------------------------

. predict residuals in 101/200, residuals
(2,400 missing values generated)

. regress y x residuals in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(2, 97)        =     24.12
       Model |  8.18329669         2  4.09164834   Prob > F        =    0.0000
    Residual |  16.4567033        97  .169656735   R-squared       =    0.3321
-------------+----------------------------------   Adj R-squared   =    0.3183
       Total |       24.64        99  .248888889   Root MSE        =    .41189

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .0871093   .0390754     2.23   0.028     .0095555    .1646632
   residuals |   .0885449   .0473291     1.87   0.064    -.0053902      .18248
       _cons |   .3906352   .0864207     4.52   0.000      .219114    .5621563
------------------------------------------------------------------------------

. scalar bx4 = _b[x]

. scalar sx4 = _se[x]

. scalar bxr = _b[residuals]

. scalar sxr = _se[residuals]

. replace residuals = _n in 1/3
(3 real changes made)

. list residuals in 1/5

     +----------+
     | residu~s |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. ivtsri y (x = z1 z2 z3) in 101/200

Final GMM criterion Q(b) =  7.73e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   7
Number of moments    =   7
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .969467   .2259696     4.29   0.000     .5265747    1.412359
    /s1xb_z2 |   .7058939   .2698506     2.62   0.009     .1769965    1.234791
    /s1xb_z3 |   1.322028   .2210988     5.98   0.000     .8886818    1.755373
         /a0 |    .133577   .3267649     0.41   0.683    -.5068705    .7740245
         /b1 |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
         /b2 |   .0885449   .0431796     2.05   0.040     .0039145    .1731753
         /b0 |   .3906352   .0815149     4.79   0.000     .2308689    .5504014
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: x residuals _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
------------------------------------------------------------------------------

Causal risk difference for: b2

 ( 1)  [b2]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .0885449   .0431796     2.05   0.040     .0039145    .1731753
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. assert abs(_b[b2:_cons] - scalar(bxr)) < 1e-2

. list residuals in 1/5

     +----------+
     | residu~s |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. 
. bootstrap, reps(250): ivtsri y (x = z1 z2 z3), estonly
(running ivtsri on estimation sample)

Bootstrap replications (250): .........10.........20.........30.........40.....
> ....50.........60.........70.........80.........90.........100.........110...
> ......120.........130.........140.........150.........160.........170........
> .180.........190.........200.........210.........220.........230.........240.
> ........250 done

------------------------------------------------------------------------------
             |   Observed   Bootstrap                         Normal-based
           y | coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
           x |   .1070019    .007757    13.79   0.000     .0917986    .1222053
   residuals |   .0740544    .009064     8.17   0.000     .0562894    .0918195
       _cons |   .2879917    .016084    17.91   0.000     .2564677    .3195156
------------------------------------------------------------------------------

. 
end of do-file
      name:  ivtsri
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsri.log
  log type:  text
 closed on:   1 May 2025, 21:27:31
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivmw
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivmw.log
  log type:  text
 opened on:   1 May 2025, 21:27:31

. // ivmw cscript
. // 2021-09-12
. 
. cscript ivmw adofiles ivmw
---------------------------------------------------------------------BEGIN ivmw

-> which ivmw, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivmw.ado
*! version 0.1.0 12sep2021 Tom Palmer

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // simulate data
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // ivregress
. ivmw, window(2490) par(x): ivregress 2sls y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivregress on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivregress)

. ivmw, window(2490) par(x): ivregress liml y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivregress on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivregress)

. ivmw, window(2490) par(x): ivregress gmm y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivregress on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivregress)

. 
. // ivreg2
. ivmw, window(2490) par(x): ivreg2 y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(90) par(x): ivreg2 y (x = z1 z2 z3) in 1/100

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. 
. // ivtsps
. ivmw, window(2490) par(b1): ivtsps y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivtsps on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsps)

. ivmw, window(2490) par(b1): ivtsps y (x = z1 z2 z3), link(identity)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivtsps on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsps)

. 
. // ivtsri
. ivmw, window(2490) par(b1): ivtsri y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivtsri on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsri)

. ivmw, window(2490) par(b1): ivtsri y (x = z1 z2 z3), link(identity)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivtsri on estimation sample)

Rolling replications (11): .........10. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsri)

. 
. 
. // try quadratic exposure
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen x = z1 + z2 + z3 + u + rnormal()

. gen logitpy = -6 + x^2 + u

. gen py = invlogit(logitpy)

. replace py = 0.99 if py == 1
(129 real changes made)

. gen y = rbinomial(1, py)

. 
. ivmw, window(2480) par(x): ivreg2 y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (21): .........10.........20. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. 
. clear

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen x = z1 + z2 + z3 + u + rnormal()

. gen logitpy = -6 + x^2 + u

. gen py = invlogit(logitpy)

. replace py = 0.99 if py == 1
(129 real changes made)

. gen y = rbinomial(1, py)

. 
. ivmw, window(2480) par(x): ivmsmm y (x = z1 z2 z3)

Time variable: res_order, 1 to 2500
        Delta: 1 unit
(running ivmsmm on estimation sample)

Rolling replications (21): .........10.........20. done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivmsmm)

. 
. // burgess, davies, thompson paper simulations (y1-y5)
. 
. clear

. set obs 4000
Number of observations (_N) was 0, now 4,000.

. set seed 12345

. gen g = rbinomial(2, .3)

. gen u = runiform()

. gen ex = rexponential(1)

. gen x = .25*g + u + ex

. gen ey = rnormal()

. gen y1 = .4*x + .8*u + ey

. gen y2 = .1*x^2

. gen y3 = .2*(x - 1)^2

. gen y4 = .3*(x - 2)^2

. gen y5 = max(x - 2, 0)

. gen y6 = -.1*x^2

. gen y7 = (x - 5)^2

. 
. twoway line y1 x, sort(x)

. twoway line y2 y3 y4 x, sort(x)

. twoway line y5 x, sort(x)

. twoway line y6 y7 x, sort(x)

. 
. ivmw, window(3976) par(x): ivreg2 y1 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y2 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y3 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y4 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y5 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y6 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. ivmw, window(3976) par(x): ivreg2 y7 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. 
. ivmw, window(476) par(x): ivreg2 y2 (x = g) in 1/500

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (25): .........10.........20..... done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivreg2)

. 
. ivmw, window(3950) par(x) saving(ivmw): ivreg2 y2 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (51): .........10.........20.........30.........40........
> .50. done
file ivmw.dta saved
(rolling: ivreg2)

. ivmw, window(3950) par(x) saving(ivmw, replace): ivreg2 y2 (x = g)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivreg2 on estimation sample)

Rolling replications (51): .........10.........20.........30.........40........
> .50. done
file ivmw.dta saved
(rolling: ivreg2)

. use ivmw, clear
(rolling: ivreg2)

. list start-median in 1/5

     +----------------------------------------------------------------------+
     | start    end       _b_x     _b_cons      _se_x   _se_cons     median |
     |----------------------------------------------------------------------|
  1. |     1   3950    .332921   -.1959417   .0121513   .0189048   1.352454 |
  2. |     2   3951   .3315938   -.1936823   .0123205   .0191814      1.353 |
  3. |     3   3952   .3325185   -.1948544   .0123327   .0192166   1.353038 |
  4. |     4   3953   .3311778   -.1925636   .0125066    .019501   1.353228 |
  5. |     5   3954   .3321689   -.1938222   .0125251   .0195464   1.353999 |
     +----------------------------------------------------------------------+

. clear

. if c(os) == "Windows" erase ivmw.dta

. else rm ivmw.dta

. 
. // binary data for logadd, logmult, logit links
. 
. clear all

. set obs 4000
Number of observations (_N) was 0, now 4,000.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x1 = z1 + z2 + z3 + w + u + rnormal()

. gen x = x1

. gen x2 = z1 + z2 + u + rnormal()

. gen logitpy = -2 + x1 + 0.5*x2 + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. 
. ivmw, window(3991) par(x): ivlsmm y (x = z1 z2 z3)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivlsmm on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivlsmm)

. ivmw, window(3991) par(x): ivmsmm y (x = z1 z2 z3)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivmsmm on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivmsmm)

. ivmw, window(3991) par(b1): ivtsps y (x = z1 z2 z3), link(logadd)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsps on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsps)

. ivmw, window(3991) par(b1): ivtsps y (x = z1 z2 z3), link(logmult)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsps on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsps)

. ivmw, window(3991) par(b1): ivtsps y (x = z1 z2 z3), link(logit)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsps on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsps)

. ivmw, window(3991) par(b1): ivtsri y (x = z1 z2 z3), link(logadd)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsri on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsri)

. ivmw, window(3991) par(b1): ivtsri y (x = z1 z2 z3), link(logmult)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsri on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsri)

. ivmw, window(3991) par(b1): ivtsri y (x = z1 z2 z3), link(logit)

Time variable: res_order, 1 to 4000
        Delta: 1 unit
(running ivtsri on estimation sample)

Rolling replications (10): .........10 done
file /var/folders/1l/w0qjrymd3hb44s3skrzn4w4w0000gn/T//S_83240.000001 saved
    as .dta format
(rolling: ivtsri)

. 
end of do-file
      name:  ivmw
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivmw.log
  log type:  text
 closed on:   1 May 2025, 21:28:09
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  ivxtile
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivxtile.log
  log type:  text
 opened on:   1 May 2025, 21:28:09

. // ivxtile cscript
. // 2021-09-16
. 
. cscript ivxtile adofiles ivxtile
------------------------------------------------------------------BEGIN ivxtile

-> which ivxtile, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivxtile.ado
*! version 0.1.0 16sep2021 Tom Palmer

. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. // burgess, davies, thompson paper simulations (y1-y5)
. 
. clear

. set obs 4000
Number of observations (_N) was 0, now 4,000.

. set seed 12345

. gen g = rbinomial(2, .3)

. gen u = runiform()

. gen ex = rexponential(1)

. gen x = .25*g + u + ex

. gen ey = rnormal()

. gen y1 = .4*x + .8*u + ey

. gen y2 = .1*x^2

. gen y3 = .2*(x - 1)^2

. gen y4 = .3*(x - 2)^2

. gen y5 = max(x - 2, 0)

. gen y6 = -.1*x^2

. gen y7 = (x - 5)^2

. 
. discard

. ivxtile, nq(4) par(b1): ivtsps y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259411    .725597  

. 
. ivxtile, nq(4) par(b1) trace: ivtsps y2 (x = g)

First stage residuals quantile: 1


Final GMM criterion Q(b) =  1.72e-34

note: model is exactly identified.

GMM estimation 

Number of parameters =   4
Number of moments    =   4
Initial weight matrix: Unadjusted                 Number of obs   =      1,000

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
     /s1xb_g |   .2646999   .0094013    28.16   0.000     .2462737    .2831261
         /a0 |   .5016236   .0082442    60.85   0.000     .4854653    .5177819
         /b1 |    .143359   .0020305    70.60   0.000     .1393793    .1473387
         /b0 |  -.0443731   .0014091   -31.49   0.000    -.0471348   -.0416114
------------------------------------------------------------------------------
Instruments for equation 1: g _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |    .143359   .0020305    70.60   0.000     .1393793    .1473387
------------------------------------------------------------------------------

First stage residuals quantile: 2


Final GMM criterion Q(b) =  2.06e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   4
Number of moments    =   4
Initial weight matrix: Unadjusted                 Number of obs   =      1,000

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
     /s1xb_g |   .2664825   .0057948    45.99   0.000     .2551249    .2778401
         /a0 |   .9802425   .0050775   193.06   0.000     .9702908    .9901943
         /b1 |   .2388808   .0014311   166.92   0.000      .236076    .2416857
         /b0 |  -.1379062   .0015867   -86.91   0.000     -.141016   -.1347963
------------------------------------------------------------------------------
Instruments for equation 1: g _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .2388808   .0014311   166.92   0.000      .236076    .2416857
------------------------------------------------------------------------------

First stage residuals quantile: 3


Final GMM criterion Q(b) =  9.02e-33

note: model is exactly identified.

GMM estimation 

Number of parameters =   4
Number of moments    =   4
Initial weight matrix: Unadjusted                 Number of obs   =      1,000

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
     /s1xb_g |    .265626   .0092279    28.78   0.000     .2475395    .2837124
         /a0 |   1.485285   .0078079   190.23   0.000     1.469982    1.500588
         /b1 |   .3372547   .0020202   166.94   0.000     .3332952    .3412142
         /b0 |  -.2777331    .003248   -85.51   0.000     -.284099   -.2713671
------------------------------------------------------------------------------
Instruments for equation 1: g _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .3372547   .0020202   166.94   0.000     .3332952    .3412142
------------------------------------------------------------------------------

First stage residuals quantile: 4


Final GMM criterion Q(b) =  4.07e-31

note: model is exactly identified.

GMM estimation 

Number of parameters =   4
Number of moments    =   4
Initial weight matrix: Unadjusted                 Number of obs   =      1,000

------------------------------------------------------------------------------
             |               Robust
             | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
     /s1xb_g |    .272497   .0488933     5.57   0.000     .1766678    .3683262
         /a0 |   2.808065   .0433854    64.72   0.000     2.723032    2.893099
         /b1 |   .6257691   .0509326    12.29   0.000      .525943    .7255952
         /b0 |  -.8704803   .1482242    -5.87   0.000    -1.160994   -.5799662
------------------------------------------------------------------------------
Instruments for equation 1: g _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
         (1) |   .6257691   .0509326    12.29   0.000      .525943    .7255952
------------------------------------------------------------------------------

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259411    .725597  

. 
. ivxtile, nq(10) par(b1): ivtsps y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1   .1037679   .0021337   .4384223   .0995859   .1079499  
           2   .1585745   .0015963   .7513582   .1554457   .1617032  
           3   .1981476   .0015735   .9798349   .1950635   .2012317  
           4   .2285919   .0015923   1.016022    .225471   .2317128  
           5    .263626   .0014932   1.178039   .2606993   .2665527  
           6   .3018492   .0016141   1.401061   .2986855   .3050129  
           7   .3490515   .0019169   1.642947   .3452945   .3528085  
           8   .4143449   .0022951   1.994051   .4098466   .4188433  
           9   .5128626   .0030473   2.466335   .5068899   .5188352  
          10   .8345693   .0691984   3.577371   .6989404   .9701982  

. 
. ivxtile, nq(4) par(b1): ivtsps y2 (x = g), link(identity)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259411    .725597  

. 
. ivxtile, nq(4) par(b1): ivtsri y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259412   .7255971  

. ivxtile, nq(4) par(b1): ivtsri y2 (x = g), link(identity)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259412   .7255971  

. 
. ivxtile, nq(4) par(x): ivregress 2sls y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0016293   .6738393   .1401656   .1465525  
           2   .2388808       .001   1.114681   .2369208   .2408409  
           3   .3372547   .0014367   1.619635   .3344388   .3400706  
           4   .6257691   .0507258   2.671655   .5263464   .7251917  

. ivxtile, nq(4) par(x): ivregress liml y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0016293   .6738393   .1401656   .1465525  
           2   .2388808       .001   1.114681   .2369208   .2408409  
           3   .3372547   .0014367   1.619635   .3344388   .3400706  
           4   .6257691   .0507258   2.671655   .5263464   .7251917  

. ivxtile, nq(4) par(x): ivregress gmm y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0020305   .6738393   .1393792   .1473388  
           2   .2388808   .0014311   1.114681   .2360759   .2416857  
           3   .3372547   .0020202   1.619635   .3332951   .3412143  
           4   .6257691   .0509326   2.671655   .5259411    .725597  

. 
. ivxtile, nq(4) par(x): ivreg2 y2 (x = g)

    quantile       beta         se   medendog      lowci      uppci  
           1    .143359   .0016293   .6738393   .1401656   .1465525  
           2   .2388808       .001   1.114681   .2369208   .2408409  
           3   .3372547   .0014367   1.619635   .3344388   .3400706  
           4   .6257691   .0507258   2.671655   .5263464   .7251917  

. 
. // binary data for other link functions
. 
. clear all

. set obs 4000
Number of observations (_N) was 0, now 4,000.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x1 = z1 + z2 + z3 + w + u + rnormal()

. gen x = x1

. gen x2 = z1 + z2 + u + rnormal()

. gen logitpy = -2 + .1*x1^2 + 0.5*x2 + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. 
. twoway line logitpy x1, sort(x1)

. 
. ivxtile, nq(4) par(b1): ivtsps y (x = z1 z2 z3), link(logadd)

    quantile       beta         se    medendog      lowci      uppci  
           1   .3971276   .0844622   -.3411307   .2315817   .5626736  
           2   .3568293   .0490758     1.18101   .2606408   .4530178  
           3   .2587495   .0257603     2.29315   .2082594   .3092397  
           4   .1513078   .0139182    4.021381    .124028   .1785875  

. ivxtile, nq(4) par(b1): ivtsps y (x = z1 z2 z3), link(logmult)

    quantile       beta         se    medendog      lowci      uppci  
           1    .347589   .0914038   -.3411307   .1684376   .5267404  
           2   .3328463   .0555028     1.18101   .2240608   .4416318  
           3   .2706741   .0329476     2.29315   .2060968   .3352513  
           4   .1605982   .0169347    4.021381   .1274062   .1937901  

. ivxtile, nq(4) par(b1): ivtsps y (x = z1 z2 z3), link(logit)

    quantile       beta         se    medendog      lowci      uppci  
           1   .4462928   .1007416   -.3411307   .2488392   .6437464  
           2   .4804893   .0721255     1.18101   .3391234   .6218553  
           3   .5432177   .0613731     2.29315   .4229264    .663509  
           4   .7646972   .0748999    4.021381   .6178933   .9115011  

. 
. ivxtile, nq(4) par(b1): ivtsri y (x = z1 z2 z3), link(logadd)

    quantile       beta         se    medendog      lowci      uppci  
           1   .4066803    .084106   -.3411307   .2418326   .5715281  
           2   .3597835   .0493127     1.18101   .2631306   .4564364  
           3   .2592443   .0257546     2.29315   .2087653   .3097232  
           4   .1517823    .014136    4.021381   .1240759   .1794888  

. ivxtile, nq(4) par(b1): ivtsri y (x = z1 z2 z3), link(logmult) 

    quantile       beta         se    medendog      lowci      uppci  
           1   .3471086   .1240754   -.3411307   .1039208   .5902964  
           2   .3470605   .0579449     1.18101   .2334885   .4606326  
           3   .2662629   .0334318     2.29315   .2007366   .3317892  
           4   .1753149   .0193433    4.021381    .137402   .2132278  

. ivxtile, nq(4) par(b1): ivtsri y (x = z1 z2 z3), link(logit)

    quantile       beta         se    medendog      lowci      uppci  
           1   .4742795   .1058512   -.3411307   .2668111   .6817478  
           2    .488086   .0730101     1.18101   .3449862   .6311858  
           3   .5549521   .0629268     2.29315   .4316155   .6782886  
           4   .8418363   .0839261    4.021381   .6773413   1.006331  

. 
. ivxtile, nq(4) par(x): ivmsmm y (x = z1 z2 z3)

    quantile       beta         se    medendog      lowci      uppci  
           1   .3442539   .0923321   -.3411307    .163283   .5252247  
           2   .3458917   .0582438     1.18101   .2317338   .4600495  
           3    .267333   .0328979     2.29315    .202853   .3318129  
           4   .1725606   .0195767    4.021381   .1341902    .210931  

. 
. ivxtile, nq(4) par(x): ivlsmm y (x = z1 z2 z3)

    quantile       beta         se    medendog      lowci      uppci  
           1      .4447   .1138194   -.3411307   .2216139   .6677861  
           2   .5042965   .0740131     1.18101   .3592308   .6493623  
           3   .5729357   .0638491     2.29315   .4477914     .69808  
           4   11.38396   .2653633    4.021381   10.86385   11.90408  

. 
. discard

. ivxtile, nq(4) par(x) saving(ivxtileres): ivreg2 y (x = z1 z2 z3)

    quantile       beta         se    medendog      lowci      uppci  
           1   .0349277   .0071805   -.3411307   .0208539   .0490016  
           2   .0804975   .0112173     1.18101   .0585115   .1024834  
           3   .1257521   .0131755     2.29315   .0999281   .1515761  
           4   .1176837   .0105062    4.021381   .0970914   .1382759  

. discard

. ivxtile, nq(4) par(x) saving(ivxtileres, replace): ivreg2 y (x = z1 z2 z3)

    quantile       beta         se    medendog      lowci      uppci  
           1   .0349277   .0071805   -.3411307   .0208539   .0490016  
           2   .0804975   .0112173     1.18101   .0585115   .1024834  
           3   .1257521   .0131755     2.29315   .0999281   .1515761  
           4   .1176837   .0105062    4.021381   .0970914   .1382759  

. use ivxtileres, clear

. list 

     +--------------------------------------------+
     | quantile       beta         se    medendog |
     |--------------------------------------------|
  1. |        1   .0349277   .0071805   -.3411307 |
  2. |        2   .0804975   .0112173     1.18101 |
  3. |        3   .1257521   .0131755     2.29315 |
  4. |        4   .1176837   .0105062    4.021381 |
     +--------------------------------------------+

. clear

. if c(os) == "Windows" erase ivxtileres.dta

. else rm ivxtileres.dta

. 
. // non-convergence
. clear all

. set obs 2500
Number of observations (_N) was 0, now 2,500.

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x1 = z1 + z2 + z3 + w + u + rnormal()

. gen x = x1

. gen x2 = z1 + z2 + u + rnormal()

. gen logitpy = -2 + x1 + 0.5*x2 + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. 
. ivxtile, nq(5) par(x): ivlsmm y (x = z1 z2 z3)

Model did not fit in quantile 3

    quantile       beta         se    medendog      lowci      uppci  
           1    1.40609   .1849153   -.5241845   1.043656   1.768524  
           2   1.138831   .1222908    .8047578   .8991413   1.378521  
           3          .          .    1.851269          .          .  
           4   25.19511   .9787352    2.627049   23.27678   27.11343  
           5   10.98158   .2573293    4.113728   10.47721   11.48594  

. 
end of do-file
      name:  ivxtile
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivxtile.log
  log type:  text
 closed on:   1 May 2025, 21:28:20
-------------------------------------------------------------------------------
-------------------------------------------------------------------------------
      name:  helpfiles
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/helpfiles.log
  log type:  text
 opened on:   1 May 2025, 21:28:20

. // render the helpfiles in the Results window, to check they are approx ok
. // 2021-09-06
. 
. about

StataNow/MP 18.5 for Mac (Apple Silicon)
Revision 26 Feb 2025
Copyright 1985-2023 StataCorp LLC

Total physical memory: 16.00 GB

Stata license: Unlimited-user 2-core network, expiring 29 Jan 2026
Serial number: 501809305331
  Licensed to: Tom Palmer
               University of Bristol

. 
. local helpfiles ///
> ivonesamplemr ///
> ivasmm ///
> ivlsmm ///
> ivmsmm ///
> ivtsps ///
> ivtsri ///
> iv ///
> ivmw

. 
. foreach helpfile of local helpfiles {
  2.         type ../`helpfile'.sthlp
  3. }
Title

    ivonesamplemr -- commands for one-sample Mendelian randomization (MR) /
        instrumental variable (IV) analyses.

    https://github.com/remlapmot/ivonesamplemr#readme

Commands

      ivasmm        Is simply a helpfile linking to ivregress and ivreg2,
                      which as linear IV estimators fit the additive
                      structural mean model (ASMM), i.e. estimate a causal
                      risk difference for a binary outcome.

      ivlsmm        Fits the (double) logistic structural mean model (LSMM),
                      i.e. estimates a causal odds ratio for a binary
                      outcome.

      ivmsmm        Fits the multiplicative structural mean model (MSMM),
                      i.e. estimates a causal risk ratio for a binary
                      outcome.

      ivmw          Prefix command which specifies the moving window be
                      applied to the command after the prefix, e.g. ivmw,
                      window(100): ivmsmm ....

      ivtsps        Fits two-stage predictor substitution (TSPS) estimators.

      ivtsri        Fits two-stage residual inclusion (TSRI) estimators.

      ivxtile       Prefix command which performs estimation within quantiles
                      of the first stage residuals.

      iv            Allows the use of the iv prefix, hence ivlsmm can instead
                      be called as iv lsmm ....

Description

    ivonesamplemr is a suite of programs implementing various instrumental
    variable (IV) estimators for individual level (a.k.a. one-sample) data.
    These are useful for Mendelian randomization (MR) analyses.

References

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

Author

INCLUDE help ivonesamplemr-author
Title

     ivasmm -- Additive structural mean model

Description

    ivasmm is not a command. This helpfile is to note that the additive
    structural mean model (ASMM) is simply fit with a linear IV estimator
    available in ivregress or ivreg2 or even implemented yourself with gmm.

For a binary outcome the ASMM estimates a causal risk difference.

Examples

    Read in binary outcome data; y outcome, x exposure, w covariate, z*
    instrumental variables (genotypes).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . ivregress 2sls y (x = z1)
        . ivreg2 y (x = z1)

    Fit the model with multiple instruments.

        . ivregress 2sls y (x = z1 z2 z3)
        . ivreg2 y (x = z1 z2 z3)

    Fit the model with multiple exposures, and instruments, and adjusting for
    w.

        . ivregress 2sls y w (x1 x2 = z1 z2 z3)
        . ivreg2 y w (x1 x2 = z1 z2 z3)

References

    Clarke PS, Palmer TM, Windmeijer F.  Estimating structural mean models
        with multiple instrumental variables using the Generalised Method of
        Moments.  Statistical Science, 2015, 30, 1, 96-117.  DOI

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

    Robins JM.  The analysis of randomised and nonrandomised AIDS treatment
        trials using a new approach to causal inference in longitudinal
        studies.  In Health Service Research Methodology: A Focus on AIDS (L.
        Sechrest, H. Freeman and A. Mulley, eds.).  1989. 113–159. US Public
        Health Service, National Center for Health Services Research,
        Washington, DC.

Author

INCLUDE help ivonesamplemr-author
Title

     ivlsmm -- (double) Logistic structural mean model

Syntax

        ivlsmm depvar [varlist1] (varlist2 = varlist_iv) [if] [in] [weight]
              [, options]

    varlist1 is the list of exogenous variables.

    varlist2 is the list of endogenous variables.

    varlist_iv is the list of exogenous variables used with varlist1 as
        instruments for varlist2.

    options               Description
    -------------------------------------------------------------------------
      amxb(lc:varlist)    The linear predictor for the association model, by
                            default the instruments and exogenous variables
                            are included
      from(matrix)        initial values for the parameter estimates for both
                            association and causal models
      level(#)            set confidence level; default is level(95)
      gmm_options         Options passed to gmm

Description

    ivlsmm implements the double logistic structural mean model (LSMM) of
    Vansteelandt and Goetghebeur (2003) which is a generalisation of the LSMM
    of Robins (1989).

    ivlsmm is implemented using a call to gmm.

Options

    level(#); see [R] estimation options.

Examples

    Read in binary outcome data; y outcome, x exposure, w covariate, z*
    instrumental variables (genotypes).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . ivlsmm y (x = z1)

    Fit the model with multiple instruments.

        . ivlsmm y (x = z1 z2 z3)

    Fit the model with multiple exposures, and instruments, and adjusting for
    w.

        . ivlsmm y w (x1 x2 = z1 z2 z3)

Stored results

    To see the results ivlsmm stores in e() issue ereturn list after running
    the command.

    ivlsmm stores the following in r():

    Matrices       
      r(table)            Coefficient table with rownames: b, se, z, pvalue,
                            ll, ul, df, crit, eform

References

    Clarke PS, Palmer TM, Windmeijer F.  Estimating structural mean models
        with multiple instrumental variables using the Generalised Method of
        Moments.  Statistical Science, 2015, 30, 1, 96-117.  DOI

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

    Robins JM.  The analysis of randomised and nonrandomised AIDS treatment
        trials using a new approach to causal inference in longitudinal
        studies.  In Health Service Research Methodology: A Focus on AIDS (L.
        Sechrest, H. Freeman and A. Mulley, eds.).  1989. 113–159. US Public
        Health Service, National Center for Health Services Research,
        Washington, DC.

    Vansteelandt S, Goetghebeur E.  Causal inference with generalized
        structural mean models.  Journal of the Royal Statistical Society
        (Series B).  2003, 65, 4, 817-835.  DOI

Author

INCLUDE help ivonesamplemr-author
Title

     ivmsmm -- Multiplicative structural mean model

Syntax

        ivmsmm depvar [varlist1] (varlist2 = varlist_iv) [if] [in] [weight]
              [, log noirr ivpoisson_options]

    varlist1 is the list of exogenous variables.

    varlist2 is the list of endogenous variables.

    varlist_iv is the list of exogenous variables used with varlist1 as
        instruments for varlist2.

    options               Description
    -------------------------------------------------------------------------
      noirr               Do not display exponentiated estimates
      log                 Show the GMM iteration log
      ivpoisson_options   ivpoisson##optionstbl

Description

    ivmsmm implements the multiplicative structural mean model (MSMM) of
    Robins (1989) as a wrapper to ivpoisson with the multiplicative option.
    ivpoisson performs generalized method of moments (GMM) estimation of the
    relevant moment condition using gmm.

    The equivalence of the models of Robins (1989) and Mullahy (1997), which
    was implemented in ivpois, Nichols (2007) and ivpoisson with the mult
    option, and discussed in detail by Windmeijer and Santos Silva (1997) and
    Windmeijer (2002), was shown by Palmer (2011). These models produce
    moment conditions equivalent to gamma regression Dukes and Vansteelandt
    (2018).

Options

    Please see ivpoisson##options

Examples

    Read in binary outcome data; y outcome, x exposure, w covariate, z*
    instrumental variables (genotypes).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . ivmsmm y (x = z1)

    Fit the model with multiple instruments.

        . ivmsmm y (x = z1 z2 z3)
        . estat overid

    Adjusting for w.

        . ivmsmm y w (x = z1 z2 z3)

    Fit the model with multiple exposures, and instruments, and adjusting for
    w.

        . ivmsmm y w (x1 x2 = z1 z2 z3)
        . estat overid

    Comparison with ivpois (specify onestep option to ivmsmm/ivpoisson for
    equivalence).

        . ivpois y, endog(x) exog(z1) eform(RR)
        . ivpois y, endog(x) exog(z1 z2 z3) eform(RR)
        . ivpois y w, endog(x) exog(z1 z2 z3) eform(RR)
        . ivpois y w, endog(x1 x2) exog(z1 z2 z3) eform(RR)

Stored results

    Please see ivpoisson##results

References

    Cameron AC, Trivedi PK. Regression analysis of count data. 2nd ed. 2013.
        New York, Cambridge University Press.

    Clarke PS, Palmer TM, Windmeijer F.  Estimating structural mean models
        with multiple instrumental variables using the Generalised Method of
        Moments.  Statistical Science, 2015, 30, 1, 96-117.  DOI

    Dukes O, Vansteelandt S.  A note on G-estimation of causal risk ratios.
        American Journal of Epidemiology, 2018, 187, 5, 1079-1084.  DOI

    Hernán and Robins. Instruments for causal inference: An Epidemiologist's
        dream?  Epidemiology, 2006, 17, 360-372.  DOI

    Mullahy J. Instrumental-variable estimation of count data models:
        applications to models of cigarette smoking and behavior.  The Review
        of Economics and Statistics. 1997, 79, 4, 586-593.  DOI

    Nichols A. ivpois: Stata module for IV/GMM Poisson regression. 2007.  URL

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

    Robins JM.  The analysis of randomised and nonrandomised AIDS treatment
        trials using a new approach to causal inference in longitudinal
        studies.  In Health Service Research Methodology: A Focus on AIDS (L.
        Sechrest, H. Freeman and A. Mulley, eds.).  1989. 113–159. US Public
        Health Service, National Center for Health Services Research,
        Washington, DC.

    StataCorp. Stata Base Reference Manual. Release 13.  ivpoisson - Poisson
        model with continuous endogenous covariates. 2013.  URL

    Windmeijer FAG, Santos Silva JMC. Endogeneity in Count Data Models:  An
        Application to Demand for Health Care.  Journal of Applied
        Econometrics. 1997, 12, 3, 281-294.  DOI

    Windmeijer, F.  ExpEnd, A Gauss programme for non-linear GMM estimation
        of EXPonential models with ENDogenous regressors for cross section
        and panel data.  CEMMAP working paper CWP14/02. 2002.  URL

Author

INCLUDE help ivonesamplemr-author
Title

     ivtsps -- Two-stage predictor substitution estimators

Syntax

        ivtsps depvar [varlist1] (varlist2 = varlist_iv) [if] [in] [weight]
              [, link(string) log noirr gmm_options]

    varlist1 is the list of exogenous variables.

    varlist2 is the list of endogenous variables.

    varlist_iv is the list of exogenous variables used with varlist1 as
        instruments for varlist2.

    options               Description
    -------------------------------------------------------------------------
      noirr               Do not display exponentiated estimates
      link(string)        Link function for the second stage model (identity
                            | logadd | logmult | logit)
      log                 Show the GMM iteration log
      gmm_options         gmm##options

Description

    ivtsps implements two-stage predictor substitution (TSPS) estimators with
    several link functions for the second stage model (identity,
    log-additive, log-multiplicative, logit).  It is implemented using
    generalized method of moments (GMM) estimation by passing the relevant
    moment condition to the gmm command.

Options

    link(identity | logadd | logmult | logit) specifies the link function for
        the second stage model.  identity means the second stage model is a
        linear regression (which for a binary outcome estimates a causal risk
        difference).  logadd means the second stage model is a
        Poisson/log-binomial regression (which for a binary outcome estimates
        a causal risk ratio).  logmult means the second stage model is a
        gamma regression (which for a binary outcome estimates a causal risk
        ratio, Dukes and Vansteelandt, 2018).  logit means the second stage
        model is a logistic regression (which for a binary outcome estimates
        a causal odds ratio).

    Please see gmm##options

Examples

    Read in binary outcome data; y outcome, x exposure, w covariate, z*
    instrumental variables (genotypes).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . ivtsps y (x = z1)

    Fit the model with multiple instruments.

        . ivtsps y (x = z1 z2 z3)

    Fit the model with multiple instruments, and adjusting for w.

        . ivtsps y w (x = z1 z2 z3)

    Using the log additive link function.

        . ivtsps y (x = z1 z2 z3), link(logadd)

    Using the log multiplicative link function.

        . ivtsps y (x = z1 z2 z3), link(logmult)

    Using the logit link function.

        . ivtsps y (x = z1 z2 z3), link(logit)

    Bootstrap standard errors.
        . bootstrap, reps(250): ivtsps y (x = z1 z2 z3), estonly

Stored results

    Please see gmm##results

References

    Dukes O, Vansteelandt S.  A note on G-estimation of causal risk ratios.
        American Journal of Epidemiology, 2018, 187, 5, 1079-1084.  DOI

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

    Terza JV, Basu A, Rathouz PJ. 2008.  Two-stage residual inclusion
        estimation:  Addressing endogeneity in health econometric modeling.
        Journal of Health Economics 27: 531–543.  DOI

Author

INCLUDE help ivonesamplemr-author
Title

     ivtsri -- Two-stage residual inclusion estimators

Syntax

        ivtsri depvar [varlist1] (varlist2 = varlist_iv) [if] [in] [weight]
              [, link(string) log noirr gmm_options]

    varlist1 is the list of exogenous variables.

    varlist2 is the list of endogenous variables.

    varlist_iv is the list of exogenous variables used with varlist1 as
        instruments for varlist2.

    options               Description
    -------------------------------------------------------------------------
      noirr               Do not display exponentiated estimates
      link(string)        Link function for the second stage model (identity
                            | logadd | logmult | logit)
      log                 Show the GMM iteration log
      gmm_options         gmm##options

Description

    ivtsri implements two-stage residual inclusion (TSRI) estimators with
    several link functions for the second stage model (identity,
    log-additive, log-multiplicative, logit).  It is implemented using
    generalized method of moments (GMM) estimation by passing the relevant
    moment condition to the gmm command.

Options

    link(identity | logadd | logmult | logit) specifies the link function for
        the second stage model.  identity means the second stage model is a
        linear regression (which for a binary outcome estimates a causal risk
        difference).  logadd means the second stage model is a
        Poisson/log-binomial regression (which for a binary outcome estimates
        a causal risk ratio).  logmult means the second stage model is a
        gamma regression (which for a binary outcome estimates a causal risk
        ratio, Dukes and Vansteelandt, 2018).  logit means the second stage
        model is a logistic regression (which for a binary outcome estimates
        a causal odds ratio).

    Please see gmm##options

Examples

    Read in binary outcome data; y outcome, x exposure, w covariate, z*
    instrumental variables (genotypes).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . ivtsri y (x = z1)

    Fit the model with multiple instruments.

        . ivtsri y (x = z1 z2 z3)

    Fit the model with multiple instruments, and adjusting for w.

        . ivtsri y w (x = z1 z2 z3)

    Using the log additive link function.

        . ivtsri y (x = z1 z2 z3), link(logadd)

    Using the log multiplicative link function.

        . ivtsri y (x = z1 z2 z3), link(logmult)

    Using the logit link function.

        . ivtsri y (x = z1 z2 z3), link(logit)

    Bootstrap standard errors.
        . bootstrap, reps(250): ivtsri y (x = z1 z2 z3), estonly

Stored results

    Please see gmm##results

References

    Bowden J, Vansteelandt S.  Mendelian randomization analysis of
        case-control data using structural mean models.  Statistics in
        Medicine, 2011, 30, 6, 678-694.  DOI

    Dukes O, Vansteelandt S.  A note on G-estimation of causal risk ratios.
        American Journal of Epidemiology, 2018, 187, 5, 1079-1084.  DOI

    Palmer T, Thompson JR, Tobin MD, Sheehan NA, Burton PR.  Adjusting for
        bias and unmeasured confounding in Mendelian randomization studies
        with binary responses.  International Journal of Epidemiology, 2008,
        37, 5, 1161-1168.  DOI

    Palmer TM, Sterne JAC, Harbord RM, Lawlor DA, Sheehan NA, Meng S, Granell
        R, Davey Smith G, Didelez V.  Instrumental variable estimation of
        causal risk ratios and causal odds ratios in Mendelian randomization
        analyses.  American Journal of Epidemiology, 2011, 173, 12,
        1392-1403.  DOI

    Terza JV, Basu A, Rathouz PJ.  Two-stage residual inclusion estimation:
        Addressing endogeneity in health econometric modeling.  Journal of
        Health Economics. 2008, 27, 3, 531–543.  DOI

Author

INCLUDE help ivonesamplemr-author
Title

     iv -- Instrumental variable (IV) programs useful for one-sample Mendelian
randomization (MR) analyses

Syntax

        iv subcommand ... [aweight] [if] [in] [, options]

Description

    iv is a simple wrapper to the commands in the ivonesamplemr package.

    The subcommand is specified as the mrrobust program name without its iv
    prefix, i.e. ivlsmm ... can alternatively be run using the syntax iv lsmm
    ....

Options

    iv takes the options for the specified subcommand.

Examples

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivbinout
            > data, clear

    Fit the model with a single instrumental variable.

        . iv lsmm y (x = z1)

        . iv msmm y (x = z1 z2 z3)

        . iv tsps y (x = z1 z2 z3), link(logit)

        . iv tsri y (x = z1 z2 z3), link(logit)

Stored results

    iv returns the results from the specified subcommand.

Author

INCLUDE help ivonesamplemr-author
Title

     ivmw -- Moving window prefix command

Syntax

        ivmw , window(#) par(string) [saving(filename [, replace])
            rolling_options]: iv_cmd

    options                         Description
    -------------------------------------------------------------------------
      par(string)                   Parameter from the iv_cmd (ivreg2,
                                      ivmsmm, ivlsmm, ivtsps, ivtsri) to
                                      collect
      window(#)                     number of consecutive data points in each
                                      sample
      saving(filename [, replace])  Save the moving window output to a
                                      dataset.  Specify replace to overwrite
                                      the dataset if it already exists.
      rolling_options               rolling##options

Description

    ivmw implements the moving window (a.k.a. sliding / rolling window)
    approach to the estimator specified after the prefix, as per Burgess et
    al., 2014.  It is implemented as a call to rolling.

Options

    Please see rolling##options

Examples

    Simulate data with different outcome-exposure relationships; y# outcome,
    x exposure, g instrumental variable (genotype).

        . use
            https://raw.github.com/remlapmot/ivonesamplemr/main/data/ivmwdata
            > , clear

    Plot outcome-exposure relationships

        . twoway line y1 x, sort(x)
        . twoway line y2 y3 y4 x, sort(x)
        . twoway line y5 x, sort(x)

    Example moving window fits.

        . ivmw, window(3950) par(x): ivreg2 y1 (x = g)
        . ivmw, window(3950) par(x): ivreg2 y2 (x = g)
        . ivmw, window(3950) par(x): ivreg2 y3 (x = g)
        . ivmw, window(3950) par(x): ivreg2 y4 (x = g)
        . ivmw, window(3950) par(x): ivreg2 y5 (x = g)

    Change window size (e.g. for outcome y2).

        . ivmw, window(3750) par(x): ivreg2 y2 (x = g)
        . ivmw, window(3000) par(x): ivreg2 y2 (x = g)
        . ivmw, window(2000) par(x): ivreg2 y2 (x = g)
        . ivmw, window(1000) par(x): ivreg2 y2 (x = g)

    Save the moving window dataset.

        . ivmw, window(3950) par(x) saving(ivmw): ivreg2 y2 (x = g)

    Use different iv commands.

        . ivmw, window(3950) par(x): ivregress 2sls y (x = z1 z2 z3)
        . ivmw, window(3950) par(x): ivregress liml y (x = z1 z2 z3)
        . ivmw, window(3950) par(x): ivregress gmm y (x = z1 z2 z3)
        . ivmw, window(3950) par(x): ivlsmm y (x = z1 z2 z3)
        . ivmw, window(3950) par(x): ivmsmm y (x = z1 z2 z3)
        . ivmw, window(3950) par(b1): ivtsps y (x = z1 z2 z3)
        . ivmw, window(3950) par(b1): ivtsps y (x = z1 z2 z3), link(logadd)
        . ivmw, window(3950) par(b1): ivtsps y (x = z1 z2 z3), link(logmult)
        . ivmw, window(3950) par(b1): ivtsps y (x = z1 z2 z3), link(logit)
        . ivmw, window(3950) par(b1): ivtsri y (x = z1 z2 z3)
        . ivmw, window(3950) par(b1): ivtsri y (x = z1 z2 z3), link(logadd)
        . ivmw, window(3950) par(b1): ivtsri y (x = z1 z2 z3), link(logmult)
        . ivmw, window(3950) par(b1): ivtsri y (x = z1 z2 z3), link(logit)

Stored results

    Please see rolling##results

References

    Burgess S, Davies N, Thompson SG, EPIC-InterAct Consortium.  Instrumental
        variable analysis with a nonlinear exposure-outcome relationship.
        Epidemiology, 2014, 25, 6, 877-885.  DOI

    StataCorp. Stata Base Reference Manual. Release 16.  rolling -
        Rolling-window and recursive estimation. 2016.  URL

Author

INCLUDE help ivonesamplemr-author

. 
end of do-file
      name:  helpfiles
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/helpfiles.log
  log type:  text
 closed on:   1 May 2025, 21:28:20
-------------------------------------------------------------------------------

. 
. log close _all
      name:  master
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/master.log
  log type:  text
 closed on:   1 May 2025, 21:28:20
-------------------------------------------------------------------------------
