-------------------------------------------------------------------------------
      name:  ivtsps
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsps.log
  log type:  text
 opened on:  11 Sep 2021, 19:16:31

. // ivtsps cscript
. // 2021-09-06
. 
. cscript ivtsps adofiles ivtsps
-------------------------------------------------------------------BEGIN ivtsps

-> which ivtsps, usesysdir
/Users/tom/Documents/GitHub/ivonesamplemr/ivtsps.ado
*! 1.0.0 Tom Palmer 05sep2021

. 
. // simulate data
. clear

. set obs 2500
number of observations (_N) was 0, now 2,500

. set seed 12345

. gen z1 = rbinomial(2, .2)

. gen z2 = rbinomial(2, .3)

. gen z3 = rbinomial(2, .4)

. gen u = rnormal()

. gen w = rnormal()

. gen x = z1 + z2 + z3 + w + u + rnormal()

. gen logitpy = -2 + x + w + u

. gen py = invlogit(logitpy)

. gen y = rbinomial(1, py)

. gen x1 = x

. gen x2 = rnormal()

. 
. // tests
. 
. // identity link
. 
. ivregress gmm y (x = z1 z2 z3)

Instrumental variables (GMM) regression           Number of obs   =      2,500
                                                  Wald chi2(1)    =     207.53
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.3690
GMM weight matrix: Robust                         Root MSE        =     .39694

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .1071817   .0074402    14.41   0.000     .0925993    .1217642
       _cons |   .2879039   .0157363    18.30   0.000     .2570612    .3187465
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   z1 z2 z3

. scalar bx1 = _b[x]

. scalar sx1 = _se[x]

. ivtsps y (x = z1 z2 z3)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. 
. ivregress gmm y (x = z1 z2 z3) if _n <= 50

Instrumental variables (GMM) regression           Number of obs   =         50
                                                  Wald chi2(1)    =      36.62
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.5501
GMM weight matrix: Robust                         Root MSE        =     .33512

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .1781062   .0294317     6.05   0.000     .1204211    .2357912
       _cons |   .2258489   .0642993     3.51   0.000     .0998245    .3518732
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   z1 z2 z3

. scalar bx2 = _b[x]

. scalar sx2 = _se[x]

. ivtsps y (x = z1 z2 z3) if _n <= 50

Final GMM criterion Q(b) =  2.31e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =         50

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   1.060589   .3962486     2.68   0.007     .2839558    1.837222
    /s1xb_z2 |   1.148148   .3925519     2.92   0.003     .3787603    1.917535
    /s1xb_z3 |   1.403546   .3177779     4.42   0.000      .780713    2.026379
         /a0 |  -.5013724   .3595452    -1.39   0.163    -1.206068    .2033233
         /b1 |      .1713   .0290798     5.89   0.000     .1143046    .2282954
         /b0 |   .2434077   .0653369     3.73   0.000     .1153498    .3714656
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |      .1713   .0290798     5.89   0.000     .1143046    .2282954
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx2)) < 1e-3

. 
. ivtsps y (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx1)) < 1e-3

. 
. ivregress gmm y w (x = z1 z2 z3)

Instrumental variables (GMM) regression           Number of obs   =      2,500
                                                  Wald chi2(2)    =    1628.49
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.4202
GMM weight matrix: Robust                         Root MSE        =     .38051

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .1054227   .0073416    14.36   0.000     .0910334     .119812
           w |   .1159165    .010589    10.95   0.000     .0951624    .1366707
       _cons |   .2865861   .0150723    19.01   0.000     .2570449    .3161273
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   w z1 z2 z3

. scalar bx3 = _b[x]

. scalar sx3 = _se[x]

. ivtsps y w (x = z1 z2 z3), link(identity)

Final GMM criterion Q(b) =  1.30e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
 /s2exogxb_w |   .1160821   .0105911    10.96   0.000     .0953239    .1368403
         /b0 |   .2867508   .0150764    19.02   0.000     .2572016       .3163
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .1052528   .0073427    14.33   0.000     .0908613    .1196442
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(sx3)) < 1e-3

. 
. ivtsps y (x = z1 z2 z3), estonly

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(bx1)) < 1e-2

. 
. // logadd link
. 
. ivpoisson gmm y (x = z1 z2 z3), add nolog

Final GMM criterion Q(b) =  .0004684

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =      2,500
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .2111395   .0148693    14.20   0.000     .1819962    .2402828
       _cons |  -1.203142   .0468509   -25.68   0.000    -1.294969   -1.111316
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   z1 z2 z3

. scalar lrr1 = _b[x]

. scalar selrr1 = _se[x]

. ivtsps y (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  7.54e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2130699   .0149322    14.27   0.000     .1838034    .2423364
         /b0 |  -1.141337   .0389282   -29.32   0.000    -1.217634   -1.065039
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.237471   .0184781    14.27   0.000      1.20178    1.274223
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2130699   .0149322    14.27   0.000     .1838034    .2423364
         /b0 |  -1.141337   .0389282   -29.32   0.000    -1.217634   -1.065039
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.237471   .0184781    14.27   0.000      1.20178    1.274223
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr1)) < 1e-2

. 
. ivpoisson gmm y (x = z1 z2 z3) if _n <= 200, add nolog

Final GMM criterion Q(b) =  .0136351

Exponential mean model with endogenous regressors

Number of parameters =   2                         Number of obs  =        200
Number of moments    =   4
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .2041092   .0443505     4.60   0.000     .1171838    .2910346
       _cons |  -1.093612   .1396017    -7.83   0.000    -1.367226   -.8199976
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   z1 z2 z3

. scalar lrr2 = _b[x]

. scalar selrr2 = _se[x]

. ivtsps y (x = z1 z2 z3) if _n <= 200, link(logadd)

Final GMM criterion Q(b) =  1.08e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        200

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .960665   .1863621     5.15   0.000      .595402    1.325928
    /s1xb_z2 |   1.017943   .1993872     5.11   0.000     .6271518    1.408735
    /s1xb_z3 |   1.105939   .1977604     5.59   0.000     .7183356    1.493542
         /a0 |  -.1036275   .2498245    -0.41   0.678    -.5932745    .3860195
         /b1 |   .2137135   .0426471     5.01   0.000     .1301268    .2973001
         /b0 |  -1.050832   .1150838    -9.13   0.000    -1.276393   -.8252724
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.238268   .0528085     5.01   0.000     1.138973    1.346219
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr2)) < 1e-2

. 
. ivpoisson gmm y w (x = z1 z2 z3), add nolog

Final GMM criterion Q(b) =   .000531

Exponential mean model with endogenous regressors

Number of parameters =   3                         Number of obs  =      2,500
Number of moments    =   5
Initial weight matrix: Unadjusted
GMM weight matrix:     Robust

------------------------------------------------------------------------------
             |               Robust
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           x |   .2030899    .015625    13.00   0.000     .1724655    .2337143
           w |   .2455423   .0228433    10.75   0.000     .2007703    .2903144
       _cons |  -1.273175   .0445619   -28.57   0.000    -1.360515   -1.185836
------------------------------------------------------------------------------
Instrumented:  x
Instruments:   w z1 z2 z3

. scalar lrr3 = _b[x]

. scalar selrr3 = _se[x]

. ivtsps y w (x = z1 z2 z3), link(logadd)

Final GMM criterion Q(b) =  1.85e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .2040871   .0154347    13.22   0.000     .1738357    .2343385
 /s2exogxb_w |   .2436231   .0224021    10.87   0.000     .1997157    .2875304
         /b0 |   -1.23406    .039312   -31.39   0.000     -1.31111    -1.15701
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.226405   .0189292    13.22   0.000      1.18986    1.264072
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lrr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selrr3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logadd) estonly

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .2130699   .0266058     8.01   0.000     .1609235    .2652164
       _cons |  -1.141337   .0620139   -18.40   0.000    -1.262881   -1.019792
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .2130699   .0266058     8.01   0.000     .1609235    .2652164
       _cons |  -1.141337   .0620139   -18.40   0.000    -1.262881   -1.019792
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lrr1)) < 1e-2

. 
. // logmult link
. 
. cap noi drop pred

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. glm y pred, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =      2,500
Optimization     : ML                             Residual df     =      2,498
                                                  Scale parameter =   1.180567
Deviance         =   891.997719                   (1/df) Deviance =   .3570848
Pearson          =  2949.056568                   (1/df) Pearson  =   1.180567

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .4940004
Log likelihood   = -615.5005255                   BIC             =  -18652.47

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        pred |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. scalar lmrr1 = _b[pred]

. scalar selmrr1 = _se[pred]

. ivtsps y (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  6.77e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2223683   .0179645    12.38   0.000     .1871585     .257578
         /b0 |  -1.159476   .0439471   -26.38   0.000    -1.245611   -1.073341
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.249031   .0224382    12.38   0.000     1.205818    1.293793
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .2223683   .0179645    12.38   0.000     .1871585     .257578
         /b0 |  -1.159476   .0439471   -26.38   0.000    -1.245611   -1.073341
------------------------------------------------------------------------------

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.249031   .0224382    12.38   0.000     1.205818    1.293793
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr1)) < 1e-2

. 
. cap noi drop pred

. regress x z1 z2 z3 if _n <= 250

      Source |       SS           df       MS      Number of obs   =       250
-------------+----------------------------------   F(3, 246)       =     28.81
       Model |   246.64769         3  82.2158965   Prob > F        =    0.0000
    Residual |  701.939562       246  2.85341285   R-squared       =    0.2600
-------------+----------------------------------   Adj R-squared   =    0.2510
       Total |  948.587252       249  3.80958736   Root MSE        =    1.6892

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |   .9174599   .1841768     4.98   0.000     .5546953    1.280224
          z2 |   1.066763   .1764941     6.04   0.000     .7191307    1.414395
          z3 |   .9295532   .1622004     5.73   0.000     .6100745    1.249032
       _cons |   .0817864   .2144483     0.38   0.703    -.3406025    .5041754
------------------------------------------------------------------------------

. predict pred if _n <= 250
(option xb assumed; fitted values)
(2,250 missing values generated)

. glm y pred if _n <= 250, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =        250
Optimization     : ML                             Residual df     =        248
                                                  Scale parameter =   1.040361
Deviance         =  78.01503952                   (1/df) Deviance =   .3145768
Pearson          =  258.0095851                   (1/df) Pearson  =   1.040361

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .6363156
Log likelihood   =  -77.5394559                   BIC             =  -1291.307

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        pred |   .2041119   .0661871     3.08   0.002     .0743875    .3338362
       _cons |  -1.054149   .1345992    -7.83   0.000    -1.317959   -.7903395
------------------------------------------------------------------------------

. scalar lmrr2 = _b[pred]

. scalar selmrr2 = _se[pred]

. ivtsps y (x = z1 z2 z3) if _n <= 250, link(logmult)

Final GMM criterion Q(b) =  2.06e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        250

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9174599   .1730034     5.30   0.000     .5783795     1.25654
    /s1xb_z2 |   1.066763   .1765785     6.04   0.000     .7206756    1.412851
    /s1xb_z3 |   .9295532   .1660914     5.60   0.000     .6040201    1.255086
         /a0 |   .0817864   .2035786     0.40   0.688    -.3172202    .4807931
         /b1 |   .2041119   .0538512     3.79   0.000     .0985655    .3096582
         /b0 |  -1.054149   .1263154    -8.35   0.000    -1.301723   -.8065755
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.226435    .066045     3.79   0.000     1.103587    1.362959
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr2)) < 2e-2

. 
. cap noi drop pred

. regress x z1 z2 z3 w

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. glm y pred w, family(gamma) link(log) nolog

Generalized linear models                         Number of obs   =      2,500
Optimization     : ML                             Residual df     =      2,497
                                                  Scale parameter =   1.911145
Deviance         =  1290.467158                   (1/df) Deviance =    .516807
Pearson          =  4772.130176                   (1/df) Pearson  =   1.911145

Variance function: V(u) = u^2                     [Gamma]
Link function    : g(u) = ln(u)                   [Log]

                                                  AIC             =   .1869441
Log likelihood   = -230.6801555                   BIC             =  -18246.18

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        pred |    .307442    .028211    10.90   0.000     .2521495    .3627345
           w |   .3482615   .0392281     8.88   0.000     .2713757    .4251472
       _cons |  -1.481904   .0577018   -25.68   0.000    -1.594998   -1.368811
------------------------------------------------------------------------------

. scalar lmrr3 = _b[pred]

. scalar selmrr3 = _se[pred]

. ivtsps y w (x = z1 z2 z3), link(logmult)

Final GMM criterion Q(b) =  1.89e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |    .307442   .0271383    11.33   0.000     .2542519    .3606321
 /s2exogxb_w |   .3482615   .0360076     9.67   0.000     .2776879    .4188351
         /b0 |  -1.481904   .0640343   -23.14   0.000    -1.607409   -1.356399
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal risk ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.359942   .0369065    11.33   0.000     1.289497    1.434236
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lmrr3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selmrr3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logmult) estonly

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |                 OIM
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .2223683   .0212175    10.48   0.000     .1807828    .2639537
       _cons |  -1.159476   .0443907   -26.12   0.000     -1.24648   -1.072472
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lmrr1)) < 1e-2

. 
. // logit link
. 
. cap noi drop pred

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. logit y pred, nolog

Logistic regression                             Number of obs     =      2,500
                                                LR chi2(1)        =     127.30
                                                Prob > chi2       =     0.0000
Log likelihood = -1667.8059                     Pseudo R2         =     0.0368

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        pred |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. scalar lor1 = _b[pred]

. scalar selor1 = _se[pred]

. ivtsps y (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  6.99e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4488332   .0346899    12.94   0.000     .3808424    .5168241
         /b0 |  -.8868145   .0715273   -12.40   0.000    -1.027006   -.7466235
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.566483   .0543411    12.94   0.000     1.463517    1.676694
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .4488332   .0346899    12.94   0.000     .3808424    .5168241
         /b0 |  -.8868145   .0715273   -12.40   0.000    -1.027006   -.7466235
------------------------------------------------------------------------------

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.566483   .0543411    12.94   0.000     1.463517    1.676694
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor1)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor1)) < 1e-2

. 
. cap noi drop pred

. regress x z1 z2 z3 if _n <= 100

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     11.91
       Model |  122.239349         3  40.7464497   Prob > F        =    0.0000
    Residual |  328.524824        96  3.42213358   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2484
       Total |  450.764173        99  4.55317346   Root MSE        =    1.8499

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |    .820003   .3207528     2.56   0.012     .1833137    1.456692
          z2 |    1.41933   .3039049     4.67   0.000     .8160838    2.022577
          z3 |    .920567   .2938893     3.13   0.002     .3372012    1.503933
       _cons |  -.3875989    .404343    -0.96   0.340    -1.190214    .4150156
------------------------------------------------------------------------------

. predict pred if _n <= 100
(option xb assumed; fitted values)
(2,400 missing values generated)

. logit y pred if _n <= 100, nolog

Logistic regression                             Number of obs     =        100
                                                LR chi2(1)        =       8.11
                                                Prob > chi2       =     0.0044
Log likelihood = -65.239727                     Pseudo R2         =     0.0585

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
        pred |   .5496075   .2053162     2.68   0.007     .1471951    .9520198
       _cons |  -.9312613   .3910448    -2.38   0.017    -1.697695   -.1648277
------------------------------------------------------------------------------

. scalar lor2 = _b[pred]

. scalar selor2 = _se[pred]

. ivtsps y (x = z1 z2 z3) if _n <= 100, link(logit)

Final GMM criterion Q(b) =  2.67e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .820003   .3089263     2.65   0.008     .2145185    1.425487
    /s1xb_z2 |    1.41933   .3008394     4.72   0.000     .8296958    2.008964
    /s1xb_z3 |    .920567   .3021418     3.05   0.002       .32838    1.512754
         /a0 |  -.3875989   .3651993    -1.06   0.289    -1.103376    .3281786
         /b1 |   .5496075   .1497189     3.67   0.000     .2561639    .8430511
         /b0 |  -.9312614    .276238    -3.37   0.001    -1.472678   -.3898448
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.732573   .2593988     3.67   0.000     1.291965    2.323445
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor2)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor2)) < 1e-1

. 
. cap noi drop pred

. regress x w z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(4, 2495)      =    656.78
       Model |  5133.54915         4  1283.38729   Prob > F        =    0.0000
    Residual |  4875.41101     2,495  1.95407255   R-squared       =    0.5129
-------------+----------------------------------   Adj R-squared   =    0.5121
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.3979

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           w |   .9801363   .0278572    35.18   0.000     .9255108    1.034762
          z1 |   .9882395   .0498007    19.84   0.000     .8905846    1.085894
          z2 |   .9152859   .0432582    21.16   0.000     .8304603    1.000111
          z3 |    .954388   .0408959    23.34   0.000     .8741945    1.034581
       _cons |   .0734396   .0547431     1.34   0.180     -.033907    .1807861
------------------------------------------------------------------------------

. predict pred
(option xb assumed; fitted values)

. logit y w pred, nolog

Logistic regression                             Number of obs     =      2,500
                                                LR chi2(2)        =     706.55
                                                Prob > chi2       =     0.0000
Log likelihood = -1378.1819                     Pseudo R2         =     0.2040

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
           w |   .6330367   .0669263     9.46   0.000     .5018636    .7642098
        pred |   .5740638   .0482844    11.89   0.000     .4794282    .6686995
       _cons |  -1.149458   .0981749   -11.71   0.000    -1.341878    -.957039
------------------------------------------------------------------------------

. scalar lor3 = _b[pred]

. scalar selor3 = _se[pred]

. ivtsps y w (x = z1 z2 z3), link(logit)

Final GMM criterion Q(b) =  1.57e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   8
Number of moments    =   8
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9882395   .0505573    19.55   0.000     .8891491     1.08733
    /s1xb_z2 |   .9152859   .0431149    21.23   0.000     .8307823    .9997895
    /s1xb_z3 |    .954388   .0404106    23.62   0.000     .8751847    1.033591
     /s1xb_w |   .9801363    .027334    35.86   0.000     .9265627     1.03371
         /a0 |   .0734396   .0541988     1.36   0.175    -.0327882    .1796673
         /b1 |   .5740639   .0434765    13.20   0.000     .4888515    .6592762
 /s2exogxb_w |   .6330367   .0597833    10.59   0.000     .5158637    .7502098
         /b0 |  -1.149458   .0870355   -13.21   0.000    -1.320045   -.9788718
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 w _cons
Instruments for equation 2: predicted w _cons

Causal odds ratio for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |     exp(b)   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   1.775468   .0771911    13.20   0.000     1.630443    1.933392
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(lor3)) < 1e-2

. assert abs(_se[b1:_cons] - scalar(selor3)) < 1e-2

. 
. ivtsps y (x = z1 z2 z3), link(logit) estonly

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. ivtsps

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .4488332   .0412018    10.89   0.000     .3680791    .5295873
       _cons |  -.8868145   .0855778   -10.36   0.000    -1.054544   -.7190852
------------------------------------------------------------------------------

. mat b = e(b)

. assert abs(b[1,1] - scalar(lor1)) < 1e-2

. 
. // check errors
. 
. rcof "noi ivtsps y w (x1 x2 = z1 z2 z3)" == 198
Currently, only 1 endogenous variable is allowed
invalid syntax

. 
. // preditced varname test
. 
. cap noi drop predicted

. regress x z1 z2 z3

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(3, 2496)      =    309.62
       Model |  2714.52663         3   904.84221   Prob > F        =    0.0000
    Residual |  7294.43352     2,496  2.92244933   R-squared       =    0.2712
-------------+----------------------------------   Adj R-squared   =    0.2703
       Total |  10008.9602     2,499  4.00518614   Root MSE        =    1.7095

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |   .9945859   .0609026    16.33   0.000     .8751611    1.114011
          z2 |   .9540576   .0528847    18.04   0.000     .8503552     1.05776
          z3 |   .9554229    .050013    19.10   0.000     .8573517    1.053494
       _cons |   .0842244   .0669462     1.26   0.208    -.0470513    .2155001
------------------------------------------------------------------------------

. predict predicted
(option xb assumed; fitted values)

. regress y predicted

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =    130.88
       Model |  31.0797477         1  31.0797477   Prob > F        =    0.0000
    Residual |  593.214652     2,498  .237475842   R-squared       =    0.0498
-------------+----------------------------------   Adj R-squared   =    0.0494
       Total |    624.2944     2,499  .249817687   Root MSE        =    .48731

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .1070019   .0093533    11.44   0.000      .088661    .1253429
       _cons |   .2879917   .0196508    14.66   0.000     .2494581    .3265252
------------------------------------------------------------------------------

. scalar bx4 = _b[predicted]

. replace predicted = _n in 1/3
(3 real changes made)

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. | 1.038282 |
  5. | 1.038282 |
     +----------+

. ivtsps y (x = z1 z2 z3)

Final GMM criterion Q(b) =  7.34e-33

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =      2,500

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |   .9945859   .0614877    16.18   0.000     .8740722      1.1151
    /s1xb_z2 |   .9540576   .0525572    18.15   0.000     .8510474    1.057068
    /s1xb_z3 |   .9554229   .0495052    19.30   0.000     .8583944    1.052451
         /a0 |   .0842244   .0675928     1.25   0.213    -.0482551    .2167039
         /b1 |   .1070019   .0074424    14.38   0.000      .092415    .1215889
         /b0 |   .2879917   .0157401    18.30   0.000     .2571416    .3188417
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .1070019   .0074424    14.38   0.000      .092415    .1215889
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. | 1.038282 |
  5. | 1.038282 |
     +----------+

. 
. cap noi drop predicted

. regress x z1 z2 z3 in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(3, 96)        =     14.95
       Model |  111.112814         3  37.0376048   Prob > F        =    0.0000
    Residual |   237.89687        96   2.4780924   R-squared       =    0.3184
-------------+----------------------------------   Adj R-squared   =    0.2971
       Total |  349.009685        99  3.52535035   Root MSE        =    1.5742

------------------------------------------------------------------------------
           x |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          z1 |    .969467   .2557025     3.79   0.000     .4619016    1.477032
          z2 |   .7058939   .2623521     2.69   0.008     .1851291    1.226659
          z3 |   1.322028    .243232     5.44   0.000     .8392159    1.804839
       _cons |    .133577   .3190074     0.42   0.676    -.4996476    .7668016
------------------------------------------------------------------------------

. predict predicted in 101/200
(option xb assumed; fitted values)
(2,400 missing values generated)

. regress y predicted in 101/200

      Source |       SS           df       MS      Number of obs   =       100
-------------+----------------------------------   F(1, 98)        =      3.47
       Model |   .84312816         1   .84312816   Prob > F        =    0.0654
    Residual |  23.7968718        98  .242825223   R-squared       =    0.0342
-------------+----------------------------------   Adj R-squared   =    0.0244
       Total |       24.64        99  .248888889   Root MSE        =    .49277

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
   predicted |   .0871093   .0467482     1.86   0.065    -.0056609    .1798796
       _cons |   .3906352   .1033901     3.78   0.000     .1854608    .5958095
------------------------------------------------------------------------------

. scalar bx4 = _b[predicted]

. replace predicted = _n in 1/3
(3 real changes made)

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. ivtsps y (x = z1 z2 z3) in 101/200

Final GMM criterion Q(b) =  1.09e-32

note: model is exactly identified

GMM estimation 

Number of parameters =   6
Number of moments    =   6
Initial weight matrix: Unadjusted                 Number of obs   =        100

------------------------------------------------------------------------------
             |               Robust
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
    /s1xb_z1 |    .969467   .2259696     4.29   0.000     .5265747    1.412359
    /s1xb_z2 |   .7058939   .2698506     2.62   0.009     .1769965    1.234791
    /s1xb_z3 |   1.322028   .2210988     5.98   0.000     .8886818    1.755373
         /a0 |    .133577   .3267649     0.41   0.683    -.5068705    .7740245
         /b1 |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
         /b0 |   .3906352   .0815149     4.79   0.000     .2308689    .5504014
------------------------------------------------------------------------------
Instruments for equation 1: z1 z2 z3 _cons
Instruments for equation 2: predicted _cons

Causal risk difference for: b1

 ( 1)  [b1]_cons = 0

------------------------------------------------------------------------------
             |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         (1) |   .0871093   .0350839     2.48   0.013     .0183461    .1558725
------------------------------------------------------------------------------

. assert abs(_b[b1:_cons] - scalar(bx4)) < 1e-2

. list predicted in 1/5

     +----------+
     | predic~d |
     |----------|
  1. |        1 |
  2. |        2 |
  3. |        3 |
  4. |        . |
  5. |        . |
     +----------+

. 
end of do-file
      name:  ivtsps
       log:  /Users/tom/Documents/GitHub/ivonesamplemr/cscripts/ivtsps.log
  log type:  text
 closed on:  11 Sep 2021, 19:16:34
-------------------------------------------------------------------------------
